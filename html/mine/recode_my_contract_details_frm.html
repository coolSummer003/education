<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>合同详情</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../css/aui/aui_2_0.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/common.css" />

		<style>
	html,body{
				background:#FFF;
				color:#838383;
				height:100%;
				overflow: hidden;
		}
	body{
		background-image: url(../../image/background/contract_back.png) ;
		background-repeat: no-repeat;
		background-position: center;
		/*background-size: cover;*/
		background-size: 100% 103%; 
		overflow: auto;
	}
	.contract{
	    /*margin: 1rem 1.5rem;*/
	    /*box-shadow: 1px 1px 1px 1px;*/
	    /*padding: 1rem 0rem;*/
	    overflow: hidden;
	}
	.contract-content{
		padding:1rem 1.5rem;
		/* font-style: oblique; */
		font-size: 0.8rem;
	}
	h1{	
		text-align:center;
		/* font-style: oblique; */
		margin-top:1rem;
		color:#000000;
	}
	span{
		display: inline;
		color:#000000;
		font-size: 0.7rem ! important;
		/* font-style: oblique; */
	}
	.contract-foot{
		padding:1rem 1.5rem;
		/* font-style: oblique; */
	}
	li{
		font-size:  0.7rem !important;
		margin-left: 1rem;
		display: flex;
		flex-flow: row;
		margin-bottom: 0.5rem;
	}
	li div{
		width: 4rem;
	}
	.red{
		color:#3F86FF;;
	}
	.contract-sign-txt{
		text-align: right;
	    color: #000;
	    font-style:normal;
		width: 6rem !important;
		position: relative;
		top: 0.225rem;
	}
	.contract-sign{
	    min-width: 4rem;
	    height: 3rem;
	    /*background: #FFF;*/
	    /*background:linear-gradient(270deg,rgba(63,134,254,1) 0%,rgba(100,173,246,1) 100%);*/
	    text-align: center;
	    line-height: 2rem;
	    float: right;
	    margin-right: 2rem;
	    margin-top: 0.5rem;
	    /*border-radius:100%;*/
	    color: #fff;
	}
	.dotted{
		/*border: 1px solid #3F86FF;*/
		height: 2.5rem;
		line-height: 2.5rem;
		border: 1px dashed #999999;
		color: #999999;
	}
	.signImg{
		height:100%;
	}
	.contract-sign img{
		width: 3rem;
		margin: auto;
		height: auto;
	}
	.contract img{
		width: 3rem;
		margin: auto;
		height: auto;
	}
	.img-div{
		min-height: 20rem;
		display:flex;
	}
	.btn-class-style{
		margin-top: 0.6rem !important;
		background:linear-gradient(270deg,rgba(63,134,254,1) 0%,rgba(100,173,246,1) 100%) !important;
		height: 2rem !important;
	}
	.text{
		display: flex;
		flex-flow: row;
		align-items: center;
		margin-left: 30%;
		margin-top: -5%;
	}
	.pos{
		position: absolute;
		bottom: 0.2rem;
	}
    </style>
	</head>
	<body>
		<div class='mian-content'>
			<div class="img-div">
				<img src="../../icon/common/icon_common_load.gif" alt="" />
			</div>
		</div>
		<script type="text/template" charset="UTF-8" id="mian-content">
			{{ if(it.contractType == '042002'){ }}
          <h1>医院在线签约协议</h1>
        {{ }else if(it.contractType == '042001'){ }}
          <h1>驾校在线签约协议</h1>
        {{ } }}
        <div class='contract-content'>
		  &emsp;&emsp;为维持甲乙双方合法权益在公平、自愿的基础上，双方就机动车驾驶培训达成协议如下：<br><br>
		  <ul>
		  	<li><div>甲方：</div><span style="width: 80% !important;">{{=it.organizationName}}</span></li>
		  	<li><div>地址：</div><span style="width: 80% !important;">{{=it.organizationAddress}}</span></li>
		  	<li><div>联系电话：</div><span style="width: 80% !important;">{{=it.organizationNumber}}</span></li>
		  	<li style="margin-top: 1.5rem ! important;"><div>乙方：</div><span style="width: 80% !important;">{{=it.ret.learner.name}}</span></li>
		  	<li><div>证件号：</div><span style="width: 80% !important;">{{=it.ret.learner.idcardNo}}</span></li>
		  	<li><div>联系电话：</div><span style="width: 80% !important;">{{=it.ret.learner.account}}</span></li>
		  </ul>
        </div>
					<div class='contract-foot' style="font-size: 0.6rem;">
					&emsp;&emsp;乙方签字即代表同意协议条款
					<span class='red' style="font-size: 0.6rem ! important;"　tapmode onclick="checkContract('{{=it.contractType}}')">
						{{ if(it.contractType == '042002'){ }}
						  《驾所通平台医院体检条款》
						{{ }else if(it.contractType == '042001'){ }}
						  《驾所通平台驾校报名条款》
						{{ } }}
					
					</span>
				</div>
				<div class="text">
					<div class='contract-sign-txt' style="color: #666666;">
						乙方签字：
					</div>
					<div class='contract-sign' tapmode onclick = "sign()">
						<img src="../../icon/default/icon_default_big_pic.png" onerror="javascript:this.src='../../icon/default/icon_default_big_pic.png'"   data-echo="{{=it.signB}}" alt="" tapmode />
					</div>
				</div>
				<div class="aui-btn aui-btn-info aui-btn-block btn-class-style pos" tapmode onclick="submitSign()">确认修改</div>
			</script>


	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/jquery_3_2_1_min.js"></script>
	<script type="text/javascript" src="../../script/doT_min.js"></script>
	<script type="text/javascript" src="../../script/common/common.js"></script>
	<script src="../../script/echo.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		var cache;
		var systemType; //系统类型
		var touchStyle;
		var headerPos;
		var threshold; //定义的阈值
		var learnerId;
		var contractType;
		var organizationId;
		var id;
		var signB;
		var imageFilter;
		var isFinish = false; //标记是否完成签约
		apiready = function() {
			//延迟加载图片
			imageFilter = api.require('imageFilter');
			setTimeout(function() {
				echoInit();
			}, 300);
			cache = api.pageParam.contract;
			log("cache-------", JSON.stringify(cache));
			organizationAddress = cache.organizationAddress;
			organizationNumber = cache.organizationNumber;
			organizationName = cache.organizationName;
			id = cache.id;
			headerPos = $api.offset($api.byId('aui-header1'));
			contractType = cache.contractType;
			organizationId = cache.organizationId;
			systemType = api.systemType;
			touchStyle = systemType == "ios" ? 'touchmove' : 'scroll';
			signB = cache.signB;
			init();
		}
		//提交签约
		function submitSign() {
			log('图片地址', $('.signImg').attr('src'))
			if ($('.signImg').attr('src') != undefined) {
				if (isFinish) {
					//如果完成签约
					alert_msg('您已签约');
					setTimeout(function() {
						api.closeWin({});
					}, 1000);
				} else {
					if ($('.contract-sign').find('img').length == 0) {
						alert_msg('您还未签名');
						return;
					}
					defaultload('上传协议中...');
					params = {
						bucketName: AliOssBucket,
						fileNum: 1,
						fileType: 'learnerApp/contract/' + getUserId()
					}
					var isloadFlag = 0; //标记位 isload代表是否上传，0代表未上传，1代表捕捉上传，2代表与阿里云建立连接，3代表上传完成
					getUploadFilePower(params, function(ret, err) {
						if (ret && ret.code == 0) {
							console.log('获取文件上传权限：' + JSON.stringify(ret));
							var path = ret.fileList[0].fileId;
							isloadFlag = 1; //标记上传
							//阿里云上传可能会崩，所以这里定时器：10秒后查询标记位，把isload为2的图片让用户选择上传
							var judegeCollapse = setTimeout(function() {
								collapse(isloadFlag);
							}, 10000);
							//console.log("签名地址"+ $('.signImg').attr('src'));
							//var img_srcs = $('.signImg').attr('src').split('?');
							file_upload(ret.fileList[0].signUrl, 'put', 'json', $('.signImg').attr('src'), {}, function(ret, err) {
								log('签名上传ret:', ret);
								log('签名上传err:', err);
								if (ret) {
									clearTimeout(judegeCollapse); //清除定时器
									isloadFlag = 2; //标记与阿里云服务器连接
									if (ret.progress == 100 && ret.status == 1) {
										submitInfo(path);
									}
								} else if (err) {
									log('123++++++++', err)
									//ios一直会返回数据类型错误(目前找不到原因)，但是图片已上传完毕，所以也当success返回
									if (systemType == 'ios' && err.progress == 100 && err.code == 3) {
										clearTimeout(judegeCollapse); //清除定时器
										isloadFlag = 2; //标记与阿里云服务器连接
										submitInfo(path);
									} else if ((systemType == 'ios' && err.statusCode == 0) ||
										(systemType == 'ios' && err.statusCode == 403)) {
										//同样的操作，图片上传有几率出现签名错误，这里做一个捕捉该错误并且再次提交的操作，无奈
										clearTimeout(judegeCollapse); //清除定时器
										submitSign();
									}
								}
							});
						} else {
							closedefaultload();
							alert_msg('获取文件上传权限失败，请重试');
						}
					});
				}
			} else {
				alert_msg('修改签名成功！');
				setTimeout(function() {
					esc_function('recode_my_contract_details_win', '', 'closeWin()');
				}, 1000)
			}
		}
		//提交合同信息
		function submitInfo(path) {
			url = '/api/sign-contract/update-contract';
			params = {
				contract: {
					id: id,
					signB: path,
				}
			}
			log('提交的合同信息', params);
			ajax_Request(url, 'put', 'json', params, function(ret, err) {
				closedefaultload();
				log('完成的合同信息', err);
				if (ret) {
					if (ret.code == 0) {
						isFinish = true;
						alert_msg('修改签名成功！');
						var frameName;
						if (contractType == '042001') frameName = 'recode_my_contract_frm';
						if (contractType == '042002') frameName = 'recode_my_contract_hospital_frm';
						api.execScript({
							name: 'recode_my_contract_win',
							frameName: frameName,
							script: 'refreshList()'
						});
						setTimeout(function() {
							esc_function('recode_my_contract_details_win', '', 'closeWin()');
						}, 1000)
					} else {
						//alert_msg(ret.msg);
						openMessage('温馨提示',ret.msg,'确定','',function(){},'',null)
					}
				} else {
					alert_msg('修改签名失败，请重新修改');
				}
			});
		}
		var isMsg = false; //标记是否提示过
		//点击签名
		function sign() {
			//esc_function('sign_online_win','common_sign','signOpen()');//打开画板
			if (!isMsg) {
				isMsg = true;
				openMessage_countdown('温馨提示', '&emsp;&emsp;请在签名区域写上完整姓名,然后点击确定按钮。', 'countdown', '确定', '', function() {}, '', null);
			}
			api.setFrameAttr({
				name: 'common_sign_datails',
				hidden: false
			});
		}
		//显示签名结果
		function showSign(path) {
			if (path == undefined || path == null) {
				alert_msg('签名失败');
			} else {
				imageFilter.getAttr({
					path: path
				}, function(ret, err) {
					if (ret.status) {
						console.log(JSON.stringify(ret));
					} else {
						console.log(JSON.stringify(err));
					}
				});
				$('.contract-sign').html('<img src="' + path + '" class="signImg">');
			}
		}
		function checkContract(contractType) {
			var contractType = contractType;
			params = {
				type: contractType
			}
			openFrameCommon('recode_my__details_frm', params, 0, api.winHeight, false);
		}
		function init() {
			//加载用户信息
			updateLearnerInfo(function(ret, err) {

				if (ret && ret.code == 0) {
					var params = {
						ret: ret,
						organizationName: organizationName,
						organizationNumber: organizationNumber,
						organizationAddress: organizationAddress,
						contractType: contractType,
						signB: file_load_url + signB
					}
					console.log(params.signB);
					var mianContent = $("#mian-content").html();
					$(".mian-content").html(doT.template(mianContent)(params))
				}
			});
			//先打开画板，然后关闭
			api.openFrame({
				name: 'common_sign_datails',
				url: '../mine/common_sign_datails.html',
				bgColor: 'rgba(0,0,0,0.6)',
				animation: {
					type: "none", //动画类型（详见动画类型常量）
					subType: "from_right", //动画子类型（详见动画子类型常量）
					duration: 300
				},
				rect: {
					x: 0,
					y: -api.winHeight,
					w: 'auto',
					h: api.winHeight
				},
				bounces: false,
				pageParam: null,
				softInputBarEnabled: true,
				softInputMode: 'resize'
			});
		}
		//倒计时通用弹出框
		function openMessage_countdown(title, content, type, sureButton, cancelButton, sureFunc, cancelFunc, params) {
			api.openFrame({
				name: 'common_alert_countdown',
				url: '../common/common_alert_countdown.html',
				bgColor: 'rgba(0,0,0,0.4)',
				rect: {
					x: 0,
					y: 0,
					w: 'auto',
					h: api.winHeight
				},
				bounces: false,
				pageParam: {
					title: title,
					content: content,
					type: type,
					sureButton: sureButton,
					sureFunc: sureFunc,
					cancelButton: cancelButton,
					cancelFunc: cancelFunc,
					winName: api.winName,
					frameName: api.frameName,
					params: params
				},
				softInputBarEnabled: true,
				softInputMode: 'resize'
			});
		}
		//判断是否有图片上传时候与阿里云断开连接
		function collapse(isloadFlag) {
			closedefaultload();
			if (isloadFlag == 1) {
				api.confirm({
					title: '温馨提示',
					msg: '上传照片服务器断开连接，是否重连',
					buttons: ['重新连接', '取消']
				}, function(ret, err) {
					var index = ret.buttonIndex;
					if (index == 1) {
						submitSign();
					}
				});
			}
		}
	</script>
</html>
