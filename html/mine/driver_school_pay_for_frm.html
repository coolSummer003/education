<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>驾校报名支付</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/aui/aui_2_0.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common/common.css" />
    <style>
    	html{
    		background-color: #ffffff;
    	}
    	.aui-bar-nav,.aui-bar-tab{
    	    background-color: #ffffff;
    	}
    	.aui-bar-nav{
    		color:#2c2c2c;
    		font-weight: 700;
    	}
	   	a.aui-pull-left, a.aui-pull-right {
		    color: #35A7FF;
		}
		.pic_unit{
		    overflow: hidden;
	    	background: #F3F3F3;
    	    padding-bottom: 0.5rem;
    	    /*column-count: 2;
    		column-gap: 0;*/
		}
		.pic_div{
		    width: 45.5%;
		    float: left;
		    margin: 0.5rem 0% 0rem 3%;
		    background: #FFFFFF;
		}
		.pic_div img{
			width: 100%;
		}
		.f_left{
			float: left;
		    max-width: 90%;
		    display: flex;
		}
		.f_right{
			float: right;
		}
		.pic_title{
		    margin: 0.5rem 0.7rem 0.1rem 0.7rem;
		    font-size: 0.8rem;
		    height: 2.4rem;
		}
		input[type="text"], input[type="password"], input[type="search"], input[type="email"], input[type="tel"], input[type="url"], input[type="date"], input[type="datetime-local"], input[type="time"], input[type="number"], select, textarea {
		    border: none;
		    background: none;
		    border-radius: 0;
		    box-shadow: none;
		    display: block;
		    padding: 0;
		    margin: 0;
		    width: 100%;
		    min-height: 2.7rem;
		    color: #424242;
		    font-size: 0.8rem;
		    font-family: inherit;
		    box-sizing: border-box;
		    -webkit-user-select: text;
		    user-select: text;
		    -webkit-appearance: none;
		    appearance: none;
		    -webkit-appearance: none;
		}
		.aui-list textarea {
		    overflow: auto;
		    margin: 0.5rem 0;
		    height: 5rem;
		    line-height: 1rem;
		    resize: none;
		}
		.aui-list-item-label-fushu{
		    color: #212121;
		    width: 35%;
		    min-width: 1.5rem;
		    margin: 0;
		    padding: 0;
		    padding-right: 0.25rem;
		    /* line-height: 2.2rem; */
		    position: relative;
		    overflow: hidden;
		    white-space: nowrap;
		    max-width: 100%;
		    -webkit-box-sizing: border-box;
		    box-sizing: border-box;
		    display: -webkit-box;
		    display: -webkit-flex;
		    display: flex;
		    height: 5rem;
    		line-height: 1rem;
		}
		.aui-list-item-label{
			margin-left: 1rem !important;
			font-weight: 600;
			font-size: 0.8rem;
		}
		.color_red{
			color:#DC251F !important;
		}
		.hetong{
			min-width: 14.5rem !important;
    		font-size: 0.7rem !important;
	        line-height: 1.3rem;
	        text-align: center;
	        padding-right: 0.75rem !important;
		}
		.aui-switch:checked {
		    border-color: #DC251F;
		    background-color: #DC251F;
		}
		.aui-list {
		    padding: 0;
		    margin: 0;
		    position: relative;
		    font-size: 0.8rem;
		    background: #FFFFFF;
		    padding-bottom: 1rem;
	        overflow: hidden;
		}
		.aui-btn-info.aui-active, .aui-btn-info:active {
		    color: #fff !important;
		    background-color: #DE5A58 !important;
		}
		.pay_type{
		    width: 95%;
		    text-align: center;
		}
		.pay_type img{
		    width: 6rem;
		    margin-top: 0.3rem;
		}
		.pd_left{
			padding-left:0.75rem !important;
		}
		.cancel{
		    margin-top: 1rem;
		}
		.aui-radio:checked, .aui-radio.aui-checked, .aui-checkbox:checked, .aui-checkbox.aui-checked {
		   background-color: #3F86FF !important;
		    border: solid 1px #3F86FF !important;
		    text-align: center;
		    background-clip: padding-box;
		}
		.aui-list .aui-list-item {
		    list-style: none;
		    margin: 0;
		    padding: 0;
		    padding-left: 0.75rem;
		    color: #212121;
		    background-color: #ffffff;
		    position: relative;
		    min-height: 3.5rem;
		    -webkit-box-sizing: border-box;
		    box-sizing: border-box;
		    display: -webkit-box;
		    display: -webkit-flex;
		    display: flex;
		    -webkit-box-pack: justify;
		    -webkit-justify-content: space-between;
		    justify-content: space-between;
		}
		.danwei{
			color:#A5A5A5;
			font-size:0.6rem;
		}
		.cash{
		    color: #FB6500;
		}
		.ziBig{
			font-size:1rem;
		}
		.zigeneral{
			font-size: 0.8rem;
		}
		.pay-icon{
			float: left;
			width: 80%;
    		text-align: left;
    		margin-left: 0.8rem;
		}
		.check-box{
			float: right;
		    margin-top: 0.7rem;
		}
		.aui-list.aui-form-list .aui-list-item:active {
		    background-color: #F1F1F1;
		}
		.aui-tips {
		    padding: 0 0.75rem;
		    width: 100%;
		    z-index: 99;
		    height: 1.9rem;
		    line-height: 1.9rem;
		    position: relative;
		    background-color: #D8E7FF;
		    color: #FF9036;
		    display: -webkit-box;
		    display: -webkit-flex;
		    display: flex;
		    -webkit-box-pack: justify;
		    -webkit-justify-content: space-between;
		    justify-content: space-between;
		    -webkit-align-items: center;
		    align-items: center;
		}
		.aui-icon-date{
			margin-left: 1rem;
			color: #468AFF;
		}
		.aui-tips-title{
			color: #3F86FF;
		}
		#m_pay{
			width: 81.5%;
			margin-left: 10%;
			background: linear-gradient(to left, #3F86FE , #64ADF6) !important;
		}
		.line_vertical{
			height: 0.7rem;
			width: 3px;
			background: #3F86FF;
			vertical-align: text-top;
			/*margin-top: 0.1rem;*/
			margin-right: 0.4rem;
		}
    </style>
</head>
<body>
	<div class="aui-content aui-margin-b-15">
		<div class="aui-tips aui-margin-b-15e" id="tips-1">
		    <i class="aui-iconfont aui-icon-date"></i>
		    <div class="aui-tips-title">您的驾校报名已提交，请尽快付款</div>
		    <i></i>
		    <i></i>
		</div>
	    <ul class="aui-list aui-form-list none-bottom-style">
	    	<li class="aui-list-item none-bottom-style" style="min-height: 2.5rem;">
	            <div class="aui-list-item-inner bottom-slide">
	                <div class="aui-list-item-label">
                		项&emsp;&emsp;目：
	                </div>
	                <div class="aui-list-item-input">
	                    <span id="order-title">驾校报名费用</span>
	                </div>
	            </div>
	        </li>
	        <li class="aui-list-item none-bottom-style" style="min-height: 2.5rem;">
	            <div class="aui-list-item-inner bottom-slide">
	                <div class="aui-list-item-label">
                		报名驾校：
	                </div>
	                <div class="aui-list-item-input">
	                    <span id="order-entity">获取中...</span>
	                </div>
	            </div>
	        </li>
	        <li class="aui-list-item none-bottom-style" style="min-height: 2.5rem;">
	            <div class="aui-list-item-inner bottom-slide">
	                <div class="aui-list-item-label">
                		报名时间：
	                </div>
	                <div class="aui-list-item-input">
	                    <span id="order-time">获取中...</span>
	                </div>
	            </div>
	        </li>
	        <li class="aui-list-item none-bottom-style" style="min-height: 2.5rem;" onclick='openReceipt()'>
	            <div class="aui-list-item-inner bottom-slide">
	                <div class="aui-list-item-label">
                		开具发票
	                </div>
	                <div class="aui-list-item-input">
	                   <span class="order-cash" id="entity" style="float:right;margin-right: 0.7rem;color: #3F86FF;font-size:0.6rem;">点击开具</span>
	                </div>
	            </div>
	        </li>
	        <li class="aui-list-item none-bottom-style">
	            <div class="aui-list-item-inner bottom-slide">
	                <div class="aui-list-item-label">
                		支付金额：
	                </div>
	                <div class="aui-list-item-input">
	                    <span class="cash">0.0元</span>
	                    <span class='danwei'>（一经支付，恕不退款）</span>
	                </div>
	            </div>
	        </li>
	        
	        <div id='payType'>
	        </div>
	    </ul>
	 </div>
	 <script type="text/template" charset="utf-8" id='pay_channel_src'>
	 	<div class="aui-list-item-inner pd_left" style='border-top:solid 10px #F1F1F1;'>
            <div class="aui-list-item-label" style="font-weight: 800; width: 100%;">
        		<!--请选择支付方式：-->
        		<span class="line_vertical"></span>选择支付方式：
            </div>
        </div>
	 	{{ if(it.driverSchool.paymentServiceProvider == 1){ }}
	 		<!-- 原生支付 -->
	        <li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
	            <div class="aui-list-item-input pay_method bottom-slide">
	            	<div class="pay_type zhifubao">
	            		<div class='pay-icon' tapmode onclick="selPayType(this)">
	            			<img src="../../icon/payfor/pay_zhifubao.png" alt="" />
	            		</div>
	            		<div class='check-box'>
	            			<input class="aui-radio" type="radio" name="pay_method" checked value="1">
	            		</div>
	            	</div>
	            </div>
	        </li>
	        <li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
	            <div class="aui-list-item-input pay_method bottom-slide">
	   				<div class="pay_type caifutong">
	            		<div class='pay-icon' tapmode onclick="selPayType(this)">
	            			<img src="../../icon/payfor/pay_weixin.png" alt="" />
	            		</div>
	            		<div class='check-box'>
							<input class="aui-radio " type="radio" name="pay_method" value="2"></label>
	            		</div>
	            	</div>
	        	</div>
	        </li>
	    {{ }else if(it.driverSchool.paymentServiceProvider == 2){ }}
	    	<!-- 绍兴银联 -->
	    	<li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
                <div class="aui-list-item-input pay_method bottom-slide">
                	<div class="pay_type zhifubao">
                		<div class='pay-icon' tapmode onclick="selPayType(this)">
                			<img src="../../icon/payfor/pay_zhifubao.png" alt="" />
                		</div>
                		<div class='check-box'>
                			<input class="aui-radio" type="radio" name="pay_method" checked value="3">
                		</div>
                	</div>
                </div>
	        </li>
	        <!-- <li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
	                        <div class="aui-list-item-input pay_method bottom-slide">
	               				<div class="pay_type caifutong">
	                        		<div class='pay-icon' tapmode onclick="selPayType(this)">
	                        			<img src="../../icon/payfor/pay_weixin.png" alt="" />
	                        		</div>
	                        		<div class='check-box'>
	            						<input class="aui-radio " type="radio" name="pay_method" value="4"></label>
	                        		</div>
	                        	</div>
	                    	</div>
	        </li> -->
	        <li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
                <div class="aui-list-item-input pay_method">
       				<div class="pay_type caifutong">
                		<div class='pay-icon' tapmode onclick="selPayType(this)">
                			<img src="../../icon/payfor/pay_yunshanfu.png" alt="" />
                		</div>
                		<div class='check-box'>
    						<input class="aui-radio " type="radio" name="pay_method" value="5"></label>
                		</div>
                	</div>
            	</div>
	        </li>
	    {{ }else if(it.driverSchool.paymentServiceProvider == 3){ }}
	    	<!-- 储信银联 -->
	    	<li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
                <div class="aui-list-item-input pay_method bottom-slide">
                	<div class="pay_type zhifubao">
                		<div class='pay-icon' tapmode onclick="selPayType(this)">
                			<img src="../../icon/payfor/pay_zhifubao.png" alt="" />
                		</div>
                		<div class='check-box'>
                			<input class="aui-radio" type="radio" name="pay_method" checked value="6">
                		</div>
                	</div>
                </div>
	        </li>
			<li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
	                        <div class="aui-list-item-input pay_method bottom-slide">
	               				<div class="pay_type caifutong">
	                        		<div class='pay-icon' tapmode onclick="selPayType(this)">
	                        			<img src="../../icon/payfor/pay_weixin.png" alt="" />
	                        		</div>
	                        		<div class='check-box'>
	            						<input class="aui-radio " type="radio" name="pay_method" value="7"></label>
	                        		</div>
	                        	</div>
	                    	</div>
	        </li>
	        <!--
	        <li class="aui-list-item none-bottom-style" style='min-height:2.5rem;'>
                <div class="aui-list-item-input pay_method">
       				<div class="pay_type caifutong">
                		<div class='pay-icon' tapmode onclick="selPayType(this)">
                			<img src="../../icon/payfor/pay_yunshanfu.png" alt="" />
                		</div>
                		<div class='check-box'>
    						<input class="aui-radio " type="radio" name="pay_method" value="8"></label>
                		</div>
                	</div>
            	</div>
	        </li> -->
	 	{{ } }}
	 	<div class="aui-btn aui-btn-info aui-btn-block" id="m_pay" tapmode onclick="pay()">确认支付</div>
	 </script>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery_3_2_1_min.js"></script>
<script type="text/javascript" src="../../script/doT_min.js"></script>
<script type="text/javascript" src="../../script/common/common.js"></script>
<script type="text/javascript">
	var cache;
	var aliPayPlus;//支付宝
	var wxPayPlus; // 微信支付
    var wxPlus; // 微信
	var isAllowPay = true;//是否允许去支付
	var invoiceData;//发票回调数据
	var systemType;
	apiready = function(){
		cache = api.pageParam.data;
		systemType = api.systemType;
		aliPayPlus = api.require('aliPayPlus');
		wxPayPlus = api.require('wxPayPlus');
        wxPlus = api.require('wxPlus');
		log('',cache);
		defaultload('加载订单中...');
		setTimeout(function(){
			init();
		},300);
		//选择发票action
		api.addEventListener({
		    name: 'myEvent'
		}, function(ret, err) {
		    invoiceData=ret.value;
		    if(invoiceData.is_personal=='0'){
		    	$("#entity").text(invoiceData.name);
		    }else if(invoiceData.is_personal=='1'){
		    	$("#entity").text(invoiceData.entity_name);
		    }
		});
	}
	function init(){
		url = 'api/driving-school-registration/select-user-registration-info';
		params = {
			orderId:cache.orderId,
			learnerId:getUserId()
		}
		ajax_Request(url, 'get', 'json', params, function(ret,err){
			api.hideProgress();
    		console.log('驾校报名订单详情数据：'+JSON.stringify(ret));
        	if(ret&&ret.code == 0&&ret.driverSchoolRegistration.length > 0){
        		$('#order-entity').html(ret.driverSchoolRegistration[0].driverSchool.name);
        		cache.schoolId=ret.driverSchoolRegistration[0].driverSchool.id;
        		$('#order-time').html(ret.driverSchoolRegistration[0].insertDt);
        		$('.cash').html(cashFormatO(ret.driverSchoolRegistration[0].entryFee) + "元");
        		var pay_channel_src = $('#pay_channel_src').html();
        		$('#payType').html(doT.template(pay_channel_src)(ret.driverSchoolRegistration[0]));
        		api.parseTapmode();
        	}else{
        		alert_msg('获取报名信息失败');
        	}
        });
	}
	
	//支付宝支付
	function pay(){
//	esc_function('mine_common_win','','finishPay("driver_school_pay_for_frm","driver_school_sign_up_notice_frm")');//显示通知
//		return;
		if(isAllowPay){
			logAppBuryingPoint({name:$('#order-entity').html()},'唤起支付','立刻报名','驾校列表','首页');
			defaultload('唤起支付中');
			url = 'api/driving-school-registration/arousePay';
			var channel = $("input:radio[name='pay_method']:checked").val();
			params = {
				orderId:cache.orderId,
				learnerId:getUserId(),
				channel:channel,
				systemType:systemType,
				learnerPhone: $api.getStorage('cache_by_account').cache_account.account
			}
			log('传参',params);
			if(invoiceData != undefined){
				params.applyInvoice = {
					schoolId:cache.schoolId,//驾校id
					orderId:cache.orderId,//订单号
					isPersonal:invoiceData.is_personal,//开票抬头个人/单位
					name: invoiceData.name,//个人开票时的抬头
					phone: invoiceData.phone,//电话
					mail: invoiceData.mail,//邮箱
					ein: invoiceData.ein,//税号
					entityName: invoiceData.entity_name,//单位名称
					organizationType:'2',//单位类型 驾校
					useWay:'0',//报名用途，写死
					invoiceType:'0'//开票类型
				}
			}
			ajax_Request(url, 'post', 'json', params, function(ret,err){
				log('唤起支付返回',ret);
				if(ret){
					if(ret.code == 0){
						/*原来的支付方式放弃，2019-9-19 16:21:28 炜哥*/
						if(channel == 1){
							//支付宝
							AlipPay(ret.aliPayReturn,function(){
								success_pay();
							},function(msg){
								fail_pay(msg);
							});
						}else if(channel == 2){
							//微信支付
							WechatPay(ret.wechatpayReturn,function(){
								success_pay();
							},function(msg){
								fail_pay(msg);
							});
						}else{
						    if (channel == 7) {
								closedefaultload();
                                // 调起小程序付款
                                var data = ret.miniProgramOrderParams;
                                var search = 'data=' + data;
                                wxPlus.launchMiniProgram({
                                    // apiKey: '', // 不知道是因为配置文件中已经配置过了还是什么原因，带上该项参数仅能打开微信，无法拉起小程序，注释后成功拉起小程序
                                    miniProgramType: 'release',
                                    userName: 'gh_cf4219c73151',
                                    path: 'pages/pay/pay?' + search // 传递参数
                                }, function(ret, err) {
                                    if (ret.status) {
                                        // console.log("调起微信小程序支付成功");
                                    } else {
                                        // console.log(err.code);
                                    }
                                });
								arousePay('支付页面', null, ret.payOrderNo);
						        return;
                            }
							//银联支付跳转
							arousePay('支付页面',ret.arousePayUrl,ret.payOrderNo);
						}
					}else{
						fail_pay(ret.msg);
					}
				}else{
					fail_pay('唤起支付失败');
				}
			});
		}else{
			fail_pay('已完成支付');
		}
	}
	
	/**
	 * 选择支付方式 
	 */
	function selPayType(e){
		$(e).parent().find("input[type='radio']").click();
	}
	
	/**
	 * 银联支付跳转
	 */
	function arousePay(name,path,payOrderNo) {
		params = {
			name:name,
			url:path,
			flag:'school-register', //驾校报名flag
			orderId:cache.orderId,
			winName:api.winName,
			frmName:api.frameName,
			payOrderNo:payOrderNo,
			channel:$("input:radio[name='pay_method']:checked").val()
		}
		api.openWin({
	       name: 'common_href_win',
	       url: '../common/common_href_win.html',
	       slidBackEnabled:'false',
	       vScrollBarEnabled:'false',
	       hScrollBarEnabled:'false',
	       reload:true,
	       useWKWebView:false,
	       pageParam: params
	   });
	}
	
	//开发票
	function openReceipt(){
		api.openFrame({
	        name: 'common_receipt',
	        url: '../common/common_receipt.html',
	        bgColor: 'rgba(0,0,0,0.3)',
	        rect: {
	            x: 0,
	            y: 0,
	            w: 'auto',
	            h: api.winHeight
	        },
	        pageParam: {
					data: params
				},
	        bounces: false,
	        softInputBarEnabled:true,
	        softInputMode:'resize',
	       
	    });
	}
	
	//支付成功
	function success_pay(){
		//alert_msg(msg);
		sendUploadSuccessMsgToDsm();
		api.hideProgress();
		isAllowPay = false;//支付成功后就不允许再次点击支付
		//esc_function('index','mine','func_init(1)');//渲染驾校报名
		
		setTimeout(function() {
			sendEvent('register_pay_sucesss',params);//发送驾校报名支付成功消息
			params = {
				orderId:cache.orderId
			}
			esc_function('mine_common_win','','finishPay("driver_school_pay_for_frm","driver_school_sign_up_notice_frm")');//显示通知		
		}, 500);
		
	}
	
	//失败处理
	function fail_pay(msg){
		alert_msg(msg);
		api.hideProgress();
	}
	
	/**
		 * 报名订单支付成功通知
		 */
		function sendUploadSuccessMsgToDsm() {
		  try{
		    if ("WebSocket" in window){
		         console.log("您的浏览器支持 WebSocket!");
		         /* alert("您的浏览器支持 WebSocket!"); */
		         
		         // 打开一个 web socket
		         var socket_url = '';
		         if(common_url.indexOf('dla.mohan-tech.com') != -1){
		           //正式地址
		           socket_url = 'wss://system.mohan-tech.com/dsmBack/api/websocket';
		         }else{
		           //测试地址
		           socket_url = 'ws://47.111.145.197:8280/dsmBack/api/websocket';
		         }
//				socket_url = 'ws://192.168.1.122:8777/api/websocket';
		         var ws = new WebSocket(socket_url);
		        
		         ws.onopen = function(){
				      var parm = {
				        "type":3,
				        "schoolId":cache.schoolId
				  }
				  var data = JSON.stringify(parm);
				      ws.send(data);
				  };
		        
		         ws.onmessage = function (evt) { 
		            var received_msg = evt.data;
		            /* alert("数据已接收..."); */
		         };
		        
		         ws.onclose = function(){ 
		            // 关闭 websocket
		            console.log("连接已关闭..."); 
		         };
		      }else{
		         // 浏览器不支持 WebSocket
		         console.log("您的浏览器不支持 WebSocket!");
		      }
		  }catch(e){
		  }
		}
</script>
</html>