<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>模拟器预约列表</title>
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/aui/aui_2_0.css" />
    <link rel="stylesheet" type="text/css" href="../../../css/common/common.css" />
    <style>
    	html,body{
    		background:#FFF;
    	}
    	#score{
    		height: 1rem;
    		line-height:1rem;
    		display: inline-block;
    		vertical-align: middle;
    	}
    	#score li{
    		float: left;
    		height: 1rem;
    		margin-left: 0.1rem;
    		line-height:1rem;
    		display: inline-block;
    		vertical-align: middle;
    	}
    	#score li img{
    		width: 0.7rem;
    		margin-top: 0.1rem;
    	}
    	#label li{
    		border: solid 1px #F1F1F1;
		    margin-right: 0.4rem;
		    font-size: 0.6rem;
		    padding: 0rem 0.2rem;
		    background:#F1F1F1;
    	}
    	.aui-list .aui-list-item-media {
		    width: 5.8rem;
		    height: 5.8rem;
		    position: relative;
		    padding: 0.5rem 0;
		    padding-right: 0.75rem;
		    display: inherit;
		    -webkit-flex-shrink: 0;
		    flex-shrink: 0;
		    -webkit-flex-wrap: nowrap;
		    flex-wrap: nowrap;
		    -webkit-box-align: center;
		    -webkit-align-items: flex-start;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		}
		.aui-list .aui-list-item-media img {
		    width: 100%;
		    display: block;
		    height: 100%;
		    object-fit: cover;
		}
		.msg{
			background: #FFFFFF;
		    height: 20rem;
		    text-align: center;
		    font-size:0.7rem;
		    color:#515151;
		}
		.msg img{
			width:2rem;
			margin-top: 9rem;
			margin-bottom:0.5rem;
		}
		.jiazai{
    	    font-size: 0.7rem;
		    background: #FFFFFF;
		    color: #666565;
		    padding-bottom: 0.3rem;
		    text-align: center;
		    padding-top: 0.3rem;
	    }
	    .jiazai img{
	    	width: 1.5rem;
	    }
		.aui-list:after {
		    height: 1px;
		    background-color: #FFF;
		    display: block;
		    content: '';
		    position: absolute;
		    top: auto;
		    right: auto;
		    bottom: 0;
		    left: 0;
		    width: 100%;
		    z-index: 2;
		    -webkit-transform-origin: 50% 100%;
		    transform-origin: 50% 100%;
		    pointer-events: none;
		}
		.aui-list .aui-list-item:last-child:after {
		    height: 2px;
		}
		#score span{
			color:#FFAC67;
		}
		.tag-style0{
			background:#DDEBFF !important;
			border-color:#DDEBFF !important;
			color:#75A9CB;
		}
		.tag-style1{
			background:#E9FBF9 !important;
			border-color:#E9FBF9 !important;
			color:#63BD9F;
		}
		.tag-style2{
			background:#FDF2E6 !important;
			border-color:#FDF2E6 !important;
			color:#ED9366;
		}
    </style>
</head>
<body>
	<div class="aui-content">
		<ul class="aui-list aui-media-list" id="driverSchool">
	        <!-- <li class="aui-list-item">
	            <div class="aui-media-list-item-inner">
	                <div class="aui-list-item-media">
	                    <img src="../../../image/demo/school/1.jpg">
	                </div>
	                <div class="aui-list-item-inner">
	                    <div class="aui-list-item-text">
	                        <div class="aui-list-item-title aui-ellipsis-2">上虞驾校</div>
	                        <div class="aui-info-item">上虞区</div>
	                    </div>
	                    <div class="aui-list-item-text jz">
	                    	<ul id="score">
	                    		<li><img src="../../../icon/common/icon_xing_light.png" alt="" /></li>
	                    		<li><img src="../../../icon/common/icon_xing_light.png" alt="" /></li>
	                    		<li><img src="../../../icon/common/icon_xing_light.png" alt="" /></li>
	                    		<li><img src="../../../icon/common/icon_xing_light.png" alt="" /></li>
	                    		<li><img src="../../../icon/common/icon_xing_dark.png" alt="" /></li>
	        		                        <li><span>4.0分</span></li>
	                    	</ul>
	                    	<div class="aui-info-item">
	                        	<img src="../../../icon/common/icon_location.png" style="width:0.5rem" class="aui-img-round" />
	                        	<span class="aui-margin-l-5">距离1.2km</span>
	                        </div>
	                    </div>
	                    <div class="aui-list-item-text jz">
	                        <span>报名1600元 &ensp;|&ensp;100/学时</span>
	                    </div>
	                    <div class="aui-info aui-margin-t-5" style="padding:0">
	                        <div class="aui-info-item">
	                                		<ul id="label">
	        		                    		<li><span>服务态度好</span></li>
	        		                    		<li><span>教学水平高</span></li>
	        		                    		<li><span>环境优美</span></li>
	        		                    	</ul>
	                                    </div>
	                    </div>
	                </div>
	            </div>
	        </li> -->
	    </ul>
	</div>
    <div id='load_div'>
    </div>
    <script type="text/template" charset="utf-8" id='load_src'>
    	<div class="load">
			<img src="../../../icon/common/loadding.gif" alt="" /><br>
        	<span>加载中...</span>
		</div>
    </script>
    <script type="text/template" charset="utf-8" id='msg_src'>
    	<div class="msg">
			<img src="../../../icon/common/icon_defalut.png" alt="" /><br>
        	<span>{{=it.msg}}</span>
		</div>
    </script>
    <script type="text/template" charset="utf-8" id='more_src'>
    	<div class="jiazai">
	    	<span>{{=it.msg}}</span>
	    </div>
    </script>
    <script type="text/template" charset="utf-8" id='driverSchool_src'>
    	{{ for(var i=0;i<it.length;i++){ }}
	    	<li class="aui-list-item" tapmode onclick="openDriverSchool('{{=it[i].name}}','{{=it[i].id}}')">
	            <div class="aui-media-list-item-inner">
	                <div class="aui-list-item-media">
	                    <img src="{{=file_load_url + it[i].logo}}" onerror="javascript:this.src='../../../icon/default/icon_default_list.png'">
	                </div>
	                <div class="aui-list-item-inner">
	                    <div class="aui-list-item-text">
							<div class="aui-list-item-title aui-ellipsis-1" style="width: 11rem;">{{=it[i].shortName}}</div>
	                    </div>
	                    <div class="aui-list-item-text jz">
	                    	<ul id="score">
	                    		{{=calcuStar(it[i].score).replace(new RegExp('../../icon', 'g'), '../../../icon')}}
	                    	</ul>
	                    	<div class="aui-info-item">
	                        	<!-- <img src="../../../icon/common/icon_location.png" style="width:0.4rem"/> -->
	                        {{if(it[i].distance){}}
                              <span class="aui-margin-l-5">{{=calcuDistance(it[i].distance)}}</span>
                            {{}else{}}
                              <span class="aui-margin-l-5"></span>
                            {{}}}
	                        </div>
	                    </div>
	                    <div class="aui-list-item-text jz">
	                        <div class="aui-list-item-title aui-ellipsis-2">
	                        	<span class='txt-yep txt-small'>报名费</span>
	                        	<span class='txt-yellow txt-small'>￥</span>
                        		{{ if(it[i].entryFees.length > 0){ }}
                        			<span class='txt-yellow txt-big'>
	                        			{{=cashFormat(it[i].entryFees[0])}}
		                        	</span>
		                        	<span class='txt-yellow txt-small'>起</span>
                        		{{ }else{ }}
                        			<span class='txt-yellow txt-small'>暂无报价</span>
                        		{{ } }}
	                        </div>
	                        <div class="aui-info-item">{{=it[i].district.cityName}} {{=it[i].district.areaName}}</div>
	                    </div>
	                    <div class="aui-info aui-margin-t-5" style="padding:0">
	                        <div class="aui-info-item">
	                    		<ul id="label">
		                    		{{=getLabelList(it[i].tags)}}
		                    	</ul>
	                        </div>
	                    </div>
	                </div>
	            </div>
	        </li>
        {{ } }}
    </script>
</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/jquery_3_2_1_min.js"></script>
<script type="text/javascript" src="../../../script/doT_min.js"></script>
<script type="text/javascript" src="../../../script/common/common.js"></script>
<script type="text/javascript">
	var bMap;
	var page = 1,limit = 10;
	var load_src = $('#load_src').html();//加载src
	var msg_src = $('#msg_src').html();//消息提示src
	var more_src = $('#more_src').html();//更多src
	var refresh = true;//标记是否是刷新操作
	var cache;
	apiready = function(){
		bMap = api.require('bMap');
		cache = api.pageParam.data;
		goRefrash(40,'#FFFFFF',null,null,function(){
			refreshList(sortType,sort);
		});
		goLoad(function(ret,err){
			loadList(sortType,sort);
		});
		location_city = $api.getStorage('cache_by_app').location_city;
		//监听条件筛选
		toEventListener('sign-up-action',function(ret){
			init(sortType,sort,ret.value.cityCode,ret.value.cityName);
		})
		api.refreshHeaderLoading();
	};
	
	//列表刷新
	function refreshList(sortType,sort){
		page = 1;refresh = true;
		setLoad();
		init(sortType,sort);
	}
	//列表上拉
	function loadList(sortType,sort){
		page++;refresh = false;
		setLoad();
		init(sortType,sort);
	}
	//列表初始化
	var sortType = 1;//驾校排序种类
	var sort = 1;//正续还是倒叙 1正续 2倒叙
	function init(index,value,cityCode,cityName){
		sortType = index;
		sort = value;
		mylocation(function(location_result){//获取当前定位
	        //驾校传参
	        params = {
	        	lng:location_result.lon,
	        	lat:location_result.lat,
	        	sortType:sortType - 0 + 1,
	        	sort:sort,
	        	page:page,
	        	limit:limit
	        }
			if(location_result.status){//有定位权限
				params.lng = location_result.lon;
				params.lat = location_result.lat;
			}
			
			if(cityCode != undefined&&cityCode != null){
				params.districtCode = cityCode;
			}
	        console.log('传参'+JSON.stringify(params));
	        url = 'api/driving/list';
	        ajax_Request(url, 'get', 'json', params, function(ret,err){
	        	if(ret){
	        		console.log('驾校列表数据：'+JSON.stringify(ret));
	        		if(ret.code == 0&&ret.drivingSchoolList.length > 0){
						var driverSchool_src = $('#driverSchool_src').html();
						if(refresh||$('#driverSchool').find('.aui-list-item').length == 0){
							$("#driverSchool").html(doT.template( driverSchool_src )( ret.drivingSchoolList ));
							//alert_msg('驾校列表刷新成功');
						}else{
							$("#driverSchool").append(doT.template( driverSchool_src )( ret.drivingSchoolList ));
						}
	        		}else{
	        			setMsg(refresh?cityName+'暂无驾校入驻':'暂无更多');
	        		}
	        	}else{
	        		setMsg('服务器繁忙，请稍后重试');
	        	}
	        	setTimeout(function(){
			        api.refreshHeaderLoadDone();
	        	},500);
	        });
		});
	}
	
	//设置页面加载的画面
	function setLoad(){
		if(refresh||$('#driverSchool').find('.aui-list-item').length == 0){//如果是刷新或者之前无数据的下拉刷新，全屏提示
			$('#load_div').html('');
			$("#driverSchool").html(doT.template( load_src )( null ));
		}else{
			setTimeout(function(){
				$('#load_div').html(doT.template( more_src )( {'msg':'加载更多中...','img':'../../../icon/common/jiazai.gif'} ));
			},500);
		}
	}
	
	//设置页面提示信息
	function setMsg(msg){
		if(refresh||$('#driverSchool').find('.aui-list-item').length == 0){//如果是刷新或者之前无数据的上拉加载，全屏提示
			setTimeout(function(){
				$("#driverSchool").html(doT.template( msg_src )( {'msg':msg} ));
			},500);
		}else{//原先已经有数据的情况下
			setTimeout(function(){
			    $('#load_div').html(doT.template( more_src )( {'msg':msg,'img':''} ));
			},500);
		}
	}
	
	//标签加载
	function getLabelList(tags){
		var menu = "";
		if(tags != ''&&tags != undefined&&tags != null){
			var tagList = tags.split(',');
			for(var i=0;i<(tagList.length > 3?3:tagList.length);i++){
				menu += "<li class='tag-style"+i+"'><span>"+getLabelName(tagList[i])+"</span></li>";
			}
		}
		return menu;
	}
	
	//压缩图片
	function smallerPic(e){
		returnSmallerPic($(e).attr('src'),function(url){
			$(e).attr('src',url);
		});
	}
	
	//打开模拟器预约或者实操预约
	function openDriverSchool(d_school_name,id){
		var data = {
			d_school_name:d_school_name,
			id:id
		}
		if(cache.type == 'simulator'){//模拟器预约
			commonOpenWin('simulator_appointment_detail_win',data);
		}else if(cache.type == 'practical'){//实操预约
			commonOpenWin('practical_appointment_detail_win',data);
		}
	}
</script>
</html>