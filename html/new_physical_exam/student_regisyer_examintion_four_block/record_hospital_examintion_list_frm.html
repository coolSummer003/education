<!DOCTYPE html>
<html>
<head> 
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>医院体检订单</title>
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/aui/aui_2_0.css" />
    <link rel="stylesheet" type="text/css" href="../../../css/aui/aui_list_swipe.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/common/common.css" />
    <style>
    	html,body{
    		background:#F5F5F5;
    	}
    	.clearfix:after{
    		clear: both;
    		display: block;
    	}
		.msg{
			background: #F5F5F5;
		    height: 20rem;
		    text-align: center;
		    font-size:0.7rem;
			color: #666
		}
		.msg img{
			width:8rem;
			margin-top: 9rem;
		}
		.jiazai{
    	    font-size: 0.7rem;
		    background: #F5F5F5;
		    color: #666565;
		    padding-bottom: 0.3rem;
		    text-align: center;
		    padding-top: 0.3rem;
	    }
	    .jiazai img{
	    	width: 1.5rem;
	    }
	    .list-examination{
	    }
	    .list-examination li{
    	    width: 95%;
		    margin-left: 2.5%;
		    margin-top: 1rem;
	    }
	    .order-date{
	        font-size: 0.7rem;
		    /*margin: 0.2rem 0.5rem;*/
		    /*background: #ADE5FA;*/
		    /*width: 22%;*/
		    color: #9A9FAD;
		    border-radius: 0.5rem;
		    text-align: center;
		    float: left;
		    height: 1rem;
		    display: inline-block;
	    }
	    .order-content{
	    	display: inline-block;
	    	width: 100%;
	    	overflow: hidden;
	    }
	    .hospital-headImg{
	    	width: 10%;
			float: left;
			text-align: center;
			margin-top: 0.7rem;
	    }
	    .hospital-headImg img{
	    	width:1rem;
	    }
	    .hospital-content{
	    	width: 90%;
	    	margin-left: 5%;
    		float: left;
    		padding: 0.5rem 0rem;
	    }
	    .order-cash{
	    	width: 20%;
		    float: right;
		    /*padding: 0.5rem 0rem;*/
		   font-size: 0.7rem;
		    /*padding-right: 0.5rem;*/

		    text-align: right;
		    display: inline-block;

	    }
	    .hospital-name{
	    	font-size: 0.9rem;
	    	font-weight: 500;
	    }
	    .hospital-address{
	    	font-size:0.7rem;
	    	color:#646B7E;
    	    margin-top: 0.3rem;
	    }
	    .hospital-address span{
	    	width: 3rem;
	    	color:#000;
	    }
	    .hospital-license{
	    	font-size:0.7rem;
	    	color:#646B7E;
    	    margin-top: 0.1rem;
	    }
	    .cash{
	    	float: right;
    	    color: #FF685B;
	    }
	    .cash span{
	    	font-size:0.7rem;
	    }
	    .pay-status{
    	    font-size: 0.7rem;
	    	color: #FF685B;
	    }
	    .order-button{
    		overflow: hidden;
		    padding-bottom: 0.5rem;
		    margin-right: 0.3rem;
	    }
	    .op-button{
	    	color: #61636D;
		    font-size: 0.7rem;
		    text-align: center;
		    border-radius: 25px;
		    float: right;
		    margin-right: 0.5rem;
		    background: #F4F7F7;
		    height: 1.2rem;
	        padding: 0.15rem 0.5rem 0.1rem 0.5rem;
	        /*line-height: 1.2rem;*/
	    }
	    .order-detail{
	    	background: #FFF;
		    border-radius: 0.5rem;
	    }
	    .payed{
	    	color: #21C994;
	    }
	    .hui{
	    	color:#909090 !important;
	    }
	    .order-button-detail{
	    	color:#61636D;
	    	background:#F4F7F7;
	    }
	    .goto{
	    	color: #FFF;
	    	background: linear-gradient(to left , #3F86FE,#64ADF6);
	    }
	    .order_top{
	    	padding: 0.2rem 0 0.1rem 0;
	    	width: 90%;
	    	margin-left: 5%;
	    	border-bottom: 1px solid #F5F5F5;
	    }
		.help_btn{
			height: 2rem;
			line-height: 2rem;
			width: 60%;
			background: linear-gradient(to left , #3F86FE,#64ADF6);
			color: #fff;
			border-radius: 25px;
			margin: auto;
			margin-top: 3rem;
		}
    </style>
</head>
<body>
	<ul class='list-examination'>
		<!-- <li>
			<div class='order-date'>2019-5-15</div>
			<div class='order-detail'>
				<div class='order-content'>
					<div class='hospital-headImg'>
						<img src="../../icon/hospital/icon_hospital_list.png" alt="" />
					</div>
					<div class="hospital-content">
						<div class='hospital-name'>上虞第三医院</div>
						<div class='hospital-address'>百官街道斯卡哈徐爱华擦</div>
						<div class='hospital-license'>体检方式：线上体检</div>
						<div class='hospital-license'>C1（小型汽车和C2、C3）</div>
					</div>
					<div class='order-cash'>
						<div class='cash'><span>￥</span>255</div>
						<div class='pay-status'>已成交</div>
					</div>
				</div>
				<div class='order-button'>
					<span class='op-button'>上传视频</span>
				</div>
			</div>
		</li> -->
	</ul>
	<div id='load_div'>
    </div>
    <script type="text/template" charset="utf-8" id='load_src'>
    	<div class="load">
			<img src="../../../icon/common/loadding.gif" alt="" /><br>
        	<span>加载中...</span>
		</div>
    </script>
    <script type="text/template" charset="utf-8" id='msg_src'>
    	<div class="msg">
			<img src="../../../icon/common/empty.png" alt="" /><br>
			<span>{{=it.msg}}</span>
        	<!-- <div class="help_btn" tapmode onclick="helpBtn()">帮助学员体检</div> -->
		</div>
    </script>
    <script type="text/template" charset="utf-8" id='more_src'>
    	<div class="jiazai">
	    	<span>{{=it.msg}}</span>
	    </div>
    </script>
	<script type="text/template" charset="utf-8" id='recode_hospital_examination_src'>
		{{ for(var i=0;i<it.length;i++){ }}
			<li>

				<div class='order-detail'>

					<div class="order_top clearfix">
						<div class='order-date'>{{=it[i].insertDt.substring(0,10)}}</div>
							<div class='order-cash'>
								<div class='pay-status'>
									{{ if(it[i].paymentStatus == 1){ }}
										{{ if(it[i].refundStatus == 0){ }}
										<span class='payed'>已支付</span>
										{{ }else if(it[i].refundStatus == 1 || it[i].refundStatus == 3){ }}
											<span>退款中</span>
										{{ }else if(it[i].refundStatus == 2){ }}
											<span>退款完成</span>
										{{ }else if(it[i].refundStatus == 9){ }}
											<span>退款失败</span>
										{{ } }}
										
									{{ }else if(it[i].paymentStatus == 0){ }}
										<span>未支付</span>
									{{ }else{ }}
										<span>支付失败</span>
									{{ } }}
								</div>
							</div>
					</div>

					<div class='order-content'>
						<!--<div class='hospital-headImg'>
							<img src="../../icon/hospital/icon_hospital_list.png" alt="" />
						</div>-->
						<div class="hospital-content">
							<div class='hospital-name'>{{=it[i].hospital.name}} <span class='cash'>{{=cashFormatO(it[i].examinationFee)}}<span>元</span></span></div>

							<div class='hospital-address'>{{=it[i].hospital.district.areaName}} {{=it[i].hospital.address}}</div>
							<div class='hospital-license'>
								<!-- 线下预约判断，有课程id -->
							     {{ if(it[i].offlineSetId != undefined){ }}
							     方式：线下体检
							     {{ }else if(it[i].offlineSetId == undefined&&isLocalHasVideo(it[i].id)){ }}
							   方式：线上体检
							     {{ } }}
							</div>
							<div class='hospital-license'>{{=it[i].licenseType.name}}</div>
						</div>

					</div>
					<div class='order-button'>
						<!-- 一大堆逻辑开始 -->
						<!-- 存在体检报告 -->
		    			{{ if(it[i].hospitalExamResult.length > 0){ }}
							<span class='op-button goto' tapmode onclick="openExamReport('{{=it[i].hospitalExamResult[0].id}}')">
								查看体检报告
							</span>
		    			<!-- 线上线下：只是医院体检报了名，未支付未体检 -->
			    		{{ }else if(it[i].paymentStatus == 0&&it[i].hospitalMedia.length == 0&&it[i].offlineSetId == undefined&&!isLocalHasVideo(it[i].id)){ }}
							{{ if(it[i].status.code != '014008'){ }}
			    			<span class='op-button goto' tapmode onclick="toHospitalExam('{{=it[i].id}}','{{=it[i].licenseType.code}}','{{=it[i].hospital.id}}','{{=it[i].hospital.name}}','{{=it[i].hospital.longitude}}','{{=it[i].hospital.latitude}}','{{=it[i].hospital.onoffLine}}','','0')">
								去体检
							</span>
							<span class='op-button' tapmode onclick="cancelOrder('{{=it[i].id}}')">
								取消订单
							</span>
							{{ }else{ }}
							<span class='op-button hui'>订单已取消</span>
							{{ } }}
						<!-- 线上：未支付，本地已录制好体检视频 -->
			    		{{ }else if(it[i].paymentStatus == 0&&it[i].offlineSetId == undefined&&isLocalHasVideo(it[i].id)){ }}
			    			{{ if(it[i].status.code != '014008'){ }}
			    			<span class='op-button goto' tapmode onclick="openPay('{{=it[i].id}}','{{=it[i].hospital.id}}',1,'{{=it[i].licenseType.code}}')">
			    				去缴费
			    			</span>
			    			<span class='op-button' tapmode onclick="cancelOrder('{{=it[i].id}}')">
								取消订单
							</span>
			    			{{ }else{ }}
			    			<span class='op-button hui'>订单已取消</span>
			    			{{ } }}
			    		<!-- 线上：已支付，还未上传视频、但本地未找到可以上传的视频数据，这种情况一般发生在换手机或者卸载app，不太常出现 -->
			    		{{ }else if(it[i].paymentStatus == 1&&it[i].offlineSetId == undefined&&!isLocalHasVideo(it[i].id)&&it[i].hospitalMedia.length == 0){ }}
			    			<span class="op-button goto" tapmode onclick="toHospitalExam('{{=it[i].id}}','{{=it[i].licenseType.code}}','{{=it[i].hospital.id}}','{{=it[i].hospital.name}}','{{=it[i].hospital.longitude}}','{{=it[i].hospital.latitude}}','{{=it[i].hospital.onoffLine}}','online',{{=it[i].hospitalMedia.length}})">
			    				重新体检
			    			</span>
			    		<!-- 线上：已支付，本地已录制好体检视频，但未上传 -->
			    		{{ }else if(it[i].paymentStatus == 1&&it[i].offlineSetId == undefined&&it[i].hospitalMedia.length == 0&&isLocalHasVideo(it[i].id)){ }}
			    			<span class="op-button goto" tapmode onclick="uploadExamVideo('{{=it[i].id}}',this)">
			    				上传视频
			    			</span>
			    		<!-- 线上：已支付已上传体检视频 -->
			    		{{ }else if(it[i].paymentStatus == 1&&it[i].offlineSetId == undefined&&it[i].hospitalMedia.length > 0){ }}
			    			<span class="op-button hui">
			    				{{ if(it[i].hospitalMedia[0].status == 1){ }}
				    				视频不合格
			    				{{ }else{ }}
				    				{{=it[i].status.name}}
			    				{{ } }}
			    			</span>
			    		<!-- 线下：已支付-->
			    		{{ }else if(it[i].paymentStatus == 1&&it[i].offlineSetId != undefined){ }}
			    			<span class="op-button" tapmode onclick="openMap('{{=it[i].hospital.name}}','{{=it[i].hospital.latitude}}','{{=it[i].hospital.longitude}}')">
			    				地图导航
			    			</span>
			    		{{ } }}

			    		<span class='op-button order-button-detail' tapmode onclick='openDetail("{{=it[i].id}}")'>订单详情</span>
			    		{{ if(it[i].paymentStatus == 1){ }}
			    			{{ if(it[i].invoiceId){ }}
			    				<span class='op-button order-button-detail' tapmode onclick='openReceipt("{{=it[i].invoiceId.id}}")'>查看发票</span>
							{{ }else{ }}
								<!--<span class='op-button ' tapmode onclick='openApplicationReceipt("{{=it[i].id}}","{{=it[i].hospital.id}}")'>申请开票</span>-->
							{{ } }}

			    		{{ }}}
					</div>
				</div>
			</li>
		{{ } }}
	</script>
</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/jquery_3_2_1_min.js"></script>
<script type="text/javascript" src="../../../script/doT_min.js"></script>
<script type="text/javascript" src="../../../script/common/common.js"></script>
<script type="text/javascript">
	var cache;
	var limit = 10,page = 1;
	var load_src = $('#load_src').html();//加载src
	var msg_src = $('#msg_src').html();//消息提示src
	var more_src = $('#more_src').html();//更多src
	var refresh = true;//标记是否是刷新操作
	var fs;
	var systemType;
	apiready = function(){
		cache = api.pageParam.data;
		console.log("学员信息参数------------"+JSON.stringify(cache))
		fs = api.require('fs');
		systemType = api.systemType;
		goRefrash(40,'#F5F5F5',null,null,function(){
			refreshList();
		});
		goLoad(function(ret,err){
			loadList();
		});
		api.addEventListener({
		    name: 'closeWinInv'
		}, function(ret, err) {
			if(ret.value.key1=='1'){
				refreshList();
			}
		});
		//监听支付成功回调
		toEventListener('hospital_pay_submit',function(ret){
			init();
		});
		//刷新列表监听
		toEventListener('hospital_refresh_list',function(ret){
			init();
		});
		
		//监听上传视频完成
		toEventListener('uploadVideoFinish', function(ret) {
			init();
		});
		//监听驳回
		toEventListener('reject_msg', function(ret) {
			init();
		});
		

		init();
	};
	function init(){
		//console.log('传入模考记录类型'+cache.type);
		defaultload('获取体检信息中');
		url = 'api/examination';
		params = {
			learnerId:cache.learnerId,
			limit:limit,
			page:page
		}
		ajax_Request(url, 'get', 'json', params, function(ret,err){
			log('体检订单记录',ret);
			api.hideProgress();
			if(ret){
				if(ret.code == 0&&ret.hospitalExamination.length > 0){
					var recode_hospital_examination_src = $('#recode_hospital_examination_src').html();
					if(refresh||$('.list-examination').find('li').length == 0){
						$('.list-examination').html(doT.template( recode_hospital_examination_src )( ret.hospitalExamination ));
					}else{
						$('.list-examination').append(doT.template( recode_hospital_examination_src )( ret.hospitalExamination ));
					}
				}else{
					setMsg(refresh?'暂无体检信息':'暂无更多');
				}
				setTimeout(function(){
					api.refreshHeaderLoadDone();
				},300);
			}else{
				setMsg('服务器故障');
			}
		});
	}
		//申请发票
	function openApplicationReceipt(ordId,hospitalId){
	 	api.openWin({
			name: 'common_application_receipt_status',
			url: '../common/common_application_receipt_status.html',
			slidBackEnabled: 'false',
			vScrollBarEnabled: 'false',
			hScrollBarEnabled: 'false',
			reload: true,
			pageParam: {
				organizationType:'1',
				ordId:ordId,
				hospitalId:hospitalId
			}
		});
	}
	//设置页面加载的画面
	function setLoad(){
		if(refresh||$('.list-examination').find('li').length == 0){//如果是刷新或者之前无数据的下拉刷新，全屏提示
			$('#load_div').html('');
			//$(".list-examination").html(doT.template( load_src )( null ));
		}else{
			setTimeout(function(){
				$('#load_div').html(doT.template( more_src )( {'msg':'加载更多中...','img':'../../../icon/common/jiazai.gif'} ));
			},500);
		}
	}

	//设置页面提示信息
	function setMsg(msg){
		if(refresh||$('.list-examination').find('li').length == 0){//如果是刷新或者之前无数据的上拉加载，全屏提示
			setTimeout(function(){
				$(".list-examination").html(doT.template( msg_src )( {'msg':msg} ));
			},500);
		}else{//原先已经有数据的情况下
			setTimeout(function(){
			    $('#load_div').html(doT.template( more_src )( {'msg':msg,'img':''} ));
			},500);
		}
	}

	//列表刷新
	function refreshList(){
		page = 1;refresh = true;
		setLoad();
		init();
	}
	//列表上拉
	function loadList(){
		page++;refresh = false;
		setLoad();
		init();
	}

	//获取用时时长
	function calCuTime(seconds){
		return 	Math.floor(seconds/60) + '分' + seconds%60 + '秒';
	}

	//发票
	function openReceipt(orderId){

			log('ID',orderId)
			api.openWin({
			name: 'common_receipt_status',
			url: '../common/common_receipt_status.html',
			slidBackEnabled: 'false',
			vScrollBarEnabled: 'false',
			hScrollBarEnabled: 'false',
			reload: true,
			pageParam: {
			organizationType:'1',
				orderId:orderId,
			}
			});
	}

	//本地是否含有录制视频
	function isLocalHasVideo(orderId){
		/*var isExist = false;
		var cache_by_account = $api.getStorage('cache_by_account');
		for(var key in cache_by_account){
			if(key == ('exam_result' + orderId)){
				isExist = true;
			}
		}
		return isExist;*/
		var examResult = $api.getStorage('cache_by_account')['exam_result'+orderId];
		if(examResult == null||examResult == undefined){
			return false;
		}else{
			return true;
		}
	}

	//去体检
	function toHospitalExam(orderId,licenseType,hospitalId,hospitalName,longitude,latitude,onoffLine,flag,hospitalExamResultLength){
		defaultload('获取订单信息中');
		url = 'api/sign-contract/get-online-signing-info';
		params = {
			contract:{
				learner:{
					id:cache.learnerId,
				},
				organizationId:hospitalId,
				type:'042002'
			}
		}
		ajax_Request(url, "get", "json", params, function(ret,err){
			closedefaultload();
			if(ret){
				console.log("判断签名biubiubiu"+JSON.stringify(ret))
				if(ret.code == 0){
					var hospital_data = {
						orderId:orderId,
						licenseType:licenseType,
						hospitalId:hospitalId,
						hospitalName:hospitalName,
						onoffLine:onoffLine,
						longitude:longitude,
						latitude:latitude,
						learnerId: cache.learnerId
					}
					log('医院信息',hospital_data);
					if(ret.contractList.length > 0){//存在合约信息就不需要在线签约，直接进入下一步
					log('',hospitalExamResultLength)
						if(hospitalExamResultLength == 0){
							commonOpenWin('physical_examination_notice_win', hospital_data);
						}else{
							api.openWin({
								name: 'result_win',
								url: '../physical_result/result_win.html',
								slidBackEnabled: 'false',
								vScrollBarEnabled: 'false',
								hScrollBarEnabled: 'false',
								reload: true,
								pageParam: {
									data:{
										videoBlock:'',
										orderId:orderId,
										videoLists:[],
										learnerId:cache.learnerId,
										hospital_data:hospital_data
									}
								}
							})
						}
					}else{
						hospital_data.flag = 1;
						//定义完成医院签约后的监听事件
						toEventListener('finishContractNext',function(ret,err){
							commonOpenWin('physical_examination_notice_win',ret.value);
						});
						openOnlineSign(hospital_data);//打开在线签约共通
					}
				}else{
					alert_msg(ret.msg);
				}
			}else{
				alert_msg('服务器故障');
			}
		});
	}

	//打开地图
	function openMap(hospitalName,latitude,longitude){
		params = {
			to_lon:longitude,
			latitude:latitude,
			to_name:hospitalName
		}
		api.openWin({
	       name: 'common_map_loaction_win',
	       url: '../common/common_map_loaction_win.html',
	       slidBackEnabled:'true',
	       vScrollBarEnabled:'false',
	       hScrollBarEnabled:'false',
	       reload:true,
	       pageParam: {
	           data:params
	       }
	   });
	}

	//打开支付
	function openPay(orderId,organizationId,type,licenseType){
		params = {
			orderId:orderId,
			hospitalId:organizationId,
			flag:1,
			learnerId:cache.learnerId
		}
		commonOpenWin('physical_examination_pay_for_win',params);
	}

	//上传体检视频
	function uploadExamVideo(orderId,e){
		var menu = '';
		uploadVideoExam(orderId,'index',function(){
			menu = "<span class='op-button hui'>已上传</span>";
			// menu += "<span class='op-button order-button-detail' tapmode onclick='openDetail(orderId)'>订单详情</span>"
			//menu += "<span class='op-button'>详情</span>";
			$(e).parent().html(menu);
		});
	}

	//取消订单
	function cancelOrder(orderId){
		openMessage('温馨提示','是否取消该订单','是','否','deleteOrder("'+orderId+'")',null,null);
	}

	//打开体检报告
	function openExamReport(examResultId){
		params = {
			examResultId:examResultId
		}
		openFrameAlert('report_physical_examination_frm',params,0,api.winHeight);
	}

	function deleteOrder(orderId){
		defaultload('取消订单中');
		url = 'api/examination/cancel-examination';
		params = {
			orderId:orderId,
			learnerId:cache.learnerId,
		}
		ajax_Request(url, 'put', 'json', params, function(ret,err){
			api.hideProgress();
			if(ret){
				if(ret.code == 0){
					alert_msg('取消成功');
					refreshList();
					//重新渲染我的
					//esc_function('index','mine','func_init(0)');
				}else{
					alert_msg(ret.msg);
				}
			}else{
				alert_msg('网络出错');
			}
		});
	}

	/**
	 * 打开详情
	 */
	function openDetail(orderId){
		console.log("订单id------"+orderId)
		params = {
			orderId:orderId,
			type:'examination-order',
			learnerId: cache.learnerId,
			learnerName:cache.learnerName
		}
		commonOpenWin('record_order_detail_win',params);
	}
	
	function helpBtn(){
		params = {
			learnerId: cache.learnerId
		}
		commonOpenWin('home_index_physical_examination_win',params);
	}
	
	/**
	 * 打开签约页面共通
	 */
	function openOnlineSign(params) {
	    api.openWin({
	        name: 'common_sign_online_win',
	        url: '../../common/common_sign_online_win.html',
	        slidBackEnabled: 'false',
	        vScrollBarEnabled: 'false',
	        hScrollBarEnabled: 'false',
	        reload: true,
	        pageParam: params
	    });
	}
	
</script>
</html>
