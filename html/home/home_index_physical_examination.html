<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>体检</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../css/aui/aui_2_0.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/common.css" />
		<style>
			html, body {
            background: #FFF;
            padding: 0;
            margin: 0;
        }

        body > div {
            padding: 0 5%;
        }


        .aui-media-list .aui-list-item-inner {
            display: block;
            padding-top: 0.5rem;
            padding-bottom: 0rem;
        }

        .aui-list .aui-list-item-media {
            width: 5.5rem;
            position: relative;
            padding: 0.5rem 0.75rem 0.5rem 0;
            display: flex;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
            -webkit-flex-wrap: nowrap;
            flex-wrap: nowrap;
            -webkit-box-align: center;
            -webkit-align-items: flex-start;
            align-items: flex-start;
        }

        .aui-list .aui-list-item-media img {
            width: 100%;
            display: block;
            margin: auto;
            height: 5rem;
            object-fit: cover;
        }

        .msg {
            background: #FFFFFF;
            height: 20rem;
            text-align: center;
            font-size: 0.7rem;
            color: #515151;
        }

        .msg img {
            width: 2rem;
            margin-top: 9rem;
            margin-bottom: 0.5rem;
        }

        .aui-list:after {
            height: 1px;
            background-color: #FFF;
            display: block;
            content: '';
            position: absolute;
            top: auto;
            right: auto;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 2;
            -webkit-transform-origin: 50% 100%;
            transform-origin: 50% 100%;
            pointer-events: none;
        }

        .aui-list .aui-list-item:last-child:after {
            height: 1px;
        }

        .aui-list .aui-list-item-text {
            font-size: 0.6rem;
            color: #757575;
            position: relative;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
        }

        .aui-list .aui-list-item:last-child:after {
            height: 2px;
        }

        .msg {
            background: #FFFFFF;
            height: 20rem;
            text-align: center;
            font-size: 0.8rem;
        }

        .msg img {
            width: 8rem;
            margin-top: 9rem;
        }

        .loading {
            font-size: 0.7rem;
            background: #FFFFFF;
            color: #7D7D7D;
            padding-bottom: 0.3rem;
            text-align: center;
            padding-top: 0.3rem;
        }

        .load {
            color: #7D7D7D;
        }

        .load img {
            width: 1.6rem;
            height: 1.6rem;
        }

        .aui-list:before {
            height: 0;
        }

        .aui-list-item {
            min-height: 8rem;
            color: #666 !important;
            padding: 0.5rem 0 0.5rem!important;
        }

        .aui-list .aui-list-item-inner {
            padding-right: 0;
        }


        #load_div {
            background-color: #fff;
            text-align: center;
            margin-bottom: 0.25rem;
            color: #666;
            font-size: 0.75rem;
        }

        .hospital-name {
            float: left;
            font-size: 0.8rem;
            color: #333;
            margin-right: 0.7rem;
            margin-bottom: 0.5rem;
            margin-top: 0.2rem;
        }


        #physicalExam button {
            display: block;
            float: left;
            margin: 0.25rem 0.4rem 0.25rem 0;
            padding: 0 0.5rem;
            height: 1rem;
            line-height: 1rem;
            background: #F5F6F6;
            border-radius: 1rem;
            color: #333;
            font-size: 0.6rem;
        }

        .hospital-district {
            font-size: 0.7rem;
            color: #666;
        }

        .hospital-score {
            float: right;
            height: 1rem;
            line-height: 1rem;
            color: #F5A33C;
            font-size: 0.6rem;
            margin-top: 0.25rem;
        }

        .hospital-score-star-div {
            float: right;
            height: 1rem;
            overflow: hidden;
            margin-top: 0.25rem;
        }

        .hospital-score-star-icon {
            float: left;
            height: 0.5rem;
            width: 0.5rem!important;
            margin-right: 0.25rem;
            margin-top: 0.25rem;
        }

        .hospital-img {
            width: 5.5rem!important;
            height: 4.5rem!important;
            border-radius: 0.5rem;
            background: url(../../icon/common/icon_loadding.gif) 50% 50%/1.2rem 1.2rem no-repeat;
        }

        .hospital-district {
            width: 43%!important;
        }

        .hospital-distance {
            width: 29% !important;
            font-size: 0.6rem;
            font-weight: normal;
            text-align: center;
            overflow: hidden;
        }

        .hospital-examination-fee {
            width: 28%!important;
            height: 100%;
            font-size: 0.7rem;
            text-align: right;
            overflow: hidden;
            color: #FF5C4D;
        }

        .aui-list .aui-list-item-media {
            padding: 0;
        }

        .aui-media-list .aui-list-item-inner {
            padding-top: 0;
            padding-left: 0.6rem;
        }
        .pre_load_msg{
            background: #FFFFFF;
            height: 20rem;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .pre_load_msg img{
             width: 10rem;
             margin-top: 6rem;
        }
    </style>
	</head>
	<body>
		<div class="aui-content">
			<ul class="aui-list aui-media-list" id="physicalExam">
			     <div class="pre_load_msg">
                    <img src="../../image/background/preloading.gif" alt=""/><br>
                </div>
			</ul>
		</div>
		<div id='load_div'>
		</div>
		<script type="text/template" charset="utf-8" id='load_src'>
			<div class="load">
        <img src="../../icon/common/icon_loadding.gif" alt=""/><br>
        <span>加载中...</span>
    </div>
</script>
		<script type="text/template" charset="utf-8" id='msg_src'>
			<div class="msg">
        <img src="../../icon/common/empty.png" alt=""/><br>
        <span>{{=it.msg}}</span>
    </div>
</script>
		<script type="text/template" charset="utf-8" id='more_src'>
			<div class="loading">
        <span>{{=it.msg}}</span>
    </div>
</script>
		<script type="text/template" charset="utf-8" id='physicalExam_src'>
			{{ for(var i=0;i< it.length;i++){ }}
    <li class="aui-list-item" tapmode onclick="openHospital('{{=it[i].id}}','{{=it[i].name}}','{{=it[i].onoffLine}}')">
        <div class="aui-media-list-item-inner">
            <div class="aui-list-item-media">
                <img src="{{=file_load_url + it[i].logo + '&style=image/resize,w_400'}}"
                     onerror="javascript:this.src='../../icon/default/icon_default_list.png'"
                     data-echo="{{=file_load_url + it[i].logo + '&style=image/resize,w_400'}}" class="hospital-img">
            </div>
            <div class="aui-list-item-inner">
                <div style="overflow: hidden;">
                    <div class="hospital-name">{{=it[i].name}}</div>
                    <div class="hospital-score">
                        5分
                    </div>
                    <div class="hospital-score-star-div">
                        <img src="../../icon/home/star.png" alt="" class="hospital-score-star-icon">
                    </div>
                </div>
                <div class="aui-list-item-text">
                    <div class="aui-info-item">
                        <span>工作时间：{{=it[i].examinationTime}}</span>
                    </div>
                </div>
                <!--<div style="overflow: hidden;">
                    {{=judgeOffline(it[i].onoffLine)}}
                </div>-->
                <div class="aui-row" style="height: 1.1rem; line-height: 1.1rem;margin-top: 0.5rem">
                    <div class="aui-col-xs-5 hospital-district">
                        {{=it[i].district.cityName}} {{=it[i].district.areaName}}
                    </div>
                    <div class="aui-col-xs-3 hospital-distance">
                        {{=calcuDistance(it[i].distance)}}
                    </div>
                    <div class="aui-col-xs-4 hospital-examination-fee">
                        {{ if(it[i].examinationPrice){ }}
                        ￥{{=cashFormat(it[i].examinationPrice)}}
                        {{ }else{ }}
                        暂无报价
                        {{ } }}
                    </div>
                </div>
            </div>
        </div>
    </li>
    {{ } }}
</script>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/jquery_3_2_1_min.js"></script>
	<script type="text/javascript" src="../../script/doT_min.js"></script>
	<script type="text/javascript" src="../../script/echo.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="../../script/common/common.js"></script>
	<script type="text/javascript">
		var bMap;
		var page = 1,
			limit = 10;
		var load_src = $('#load_src').html(); //加载src
		var msg_src = $('#msg_src').html(); //消息提示src
		var more_src = $('#more_src').html(); //更多src
		var refresh = true; //标记是否是刷新操作
		var location_city; //定位城市缓存
		var city_code, city_name;
		apiready = function() {
			api.parseTapmode();
			bMap = api.require('bMap');
//			goRefrash(40, '#FFFFFF', null, null, function() {
//				refreshList(sortType, sort);
//			});
			refreshList(sortType, sort);
			goLoad(function(ret, err) {
				loadList(sortType, sort);
			});
			location_city = $api.getStorage('cache_by_app').location_city;
//			api.refreshHeaderLoading();
			//监听条件筛选
			toEventListener('phyical-exam-action', function(ret) {
				page = 1;
				refresh = true;
				city_code = ret.value.cityCode;
				city_name = ret.value.cityName;
				init(sortType, sort, city_code, city_name);
			})
			toEventListener('refresh_physical_examination',function(ret,err){
                goRefrash(40, '#FFFFFF', null, null, function() {
                    refreshList(sortType, sort);
                });
                
            });
		};

		//列表刷新
		function refreshList(sortType, sort, keyWords) {
			page = 1;
			refresh = true;
			setLoad();
			scrollTo(0, 0);
			if (!(keyWords == '' || keyWords == null || keyWords == undefined)) {
				defaultload('加载中')
			}
			init(sortType, sort,city_code, city_name, keyWords);
		}

		//列表上拉
		function loadList(sortType, sort) {
			page++;
			refresh = false;
			setLoad();
			init(sortType, sort, city_code, city_name);
		}

		//列表初始化
		var sortType = 0; //医院排序种类,默认综合
		var sort = 2; //正续还是倒叙 1正续 2倒叙
		function init(index, value,cityCode,cityName,keyWords) {
			console.log(keyWords)
			sortType = index;
			sort = value;
			if (sortType == 0) {
				sort = 2;
			}
			if (!(keyWords == '' || keyWords == null || keyWords == undefined)) {
				page = 1;
				refresh = true;
			}
			mylocation(function(location_result) { //获取当前定位
				//医院传参
				params = {
					sortType: sortType - 0 + 1,
					sort: sort,
					page: page,
					limit: limit,
					keyWords: keyWords == '' || keyWords == null || keyWords == undefined ? '' : keyWords
				}
				if (location_result.status) { //有定位权限
					params.lng = location_result.lon;
					params.lat = location_result.lat;
				}
				console.log('传参' + JSON.stringify(params));
				if (cityCode != undefined || cityCode != null) {
				    //有定位城市那么根据城市去筛选
				    params.districtCode = cityCode;
				}
				url = 'api/hospital/list';
				ajax_Request(url, 'get', 'json', params, function(ret, err) {
					if (ret) {
						console.log('医院列表数据：' + JSON.stringify(ret));
						if (ret.code == 0 && ret.hospitalList.length > 0) {
							var physicalExam_src = $('#physicalExam_src').html();
							if (refresh || $('#physicalExam').find('.aui-list-item').length == 0) {
								$("#physicalExam").html(doT.template(physicalExam_src)(ret.hospitalList));
								//alert_msg('医院列表刷新成功');
							} else {
								$("#physicalExam").append(doT.template(physicalExam_src)(ret.hospitalList));
							}
							api.parseTapmode();
							echoInit();
						} else {
							setMsg(refresh ? '无医院' : '暂无更多');
						}
						closedefaultload();
					} else {
						setMsg('服务器繁忙，请稍后重试');
					}
					setTimeout(function() {
					    sendEvent("refresh_physical_examination")
						api.refreshHeaderLoadDone();
					}, 500);
				});
			});
		}

		//设置页面加载的画面
		function setLoad() {
			if (refresh || $('#physicalExam').find('.aui-list-item').length == 0) { //如果是刷新或者之前无数据的下拉刷新，全屏提示
				$('#load_div').html('');
				//$("#physicalExam").html(doT.template( load_src )( null ));
			} else {
				setTimeout(function() {
					$('#load_div').html(doT.template(more_src)({
						'msg': '加载更多中...',
						'img': '../../icon/common/jiazai.gif'
					}));
				}, 500);
			}
		}

		//设置页面提示信息
		function setMsg(msg) {
			if (refresh || $('#physicalExam').find('.aui-list-item').length == 0) { //如果是刷新或者之前无数据的上拉加载，全屏提示
				setTimeout(function() {
					$("#physicalExam").html(doT.template(msg_src)({
						'msg': msg
					}));
				}, 500);
			} else { //原先已经有数据的情况下
				setTimeout(function() {
					$('#load_div').html(doT.template(more_src)({
						'msg': msg,
						'img': ''
					}));
				}, 500);
			}
		}

		/**
		 * 渲染线上线下
		 */
		function judgeOffline(onoffLine) {
			var menu = '';
			if (onoffLine.indexOf('线上体检') != -1) {
				menu += '<button>';
				menu += '线上体检';
				menu += '</button>';
			}
			if (onoffLine.indexOf('线下体检') != -1) {
				menu += '<button>';
				menu += '线下体检';
				menu += '</button>';
			}
			return menu;
		}

		//打开医院详情页面
		function openHospital(id, name, onoffLine) {
			param = {
				'hospitalName': name
			}
			logAppBuryingPoint({id:id,name:name},'医院体检','信息采集','首页');
			var data = {
				id: id,
				name: name,
				onoffLine: onoffLine
			}
			commonOpenWin('hospital_detail_win', data);
		}
	</script>
</html>
