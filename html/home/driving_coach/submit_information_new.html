<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>学车意向</title>
		<link rel="stylesheet" type="text/css" href="../../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/aui/aui_2_0.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/common/common.css" />
		<style>
			html,body{
    		background-color: #efeff4;
    	}
    	.aui-bar-nav,.aui-bar-tab{
    	    background-color: #ffffff;
    	}
    	.aui-bar-nav{
    		color:#2c2c2c;
    	}
	   	a.aui-pull-left, a.aui-pull-right {
		    color: #35A7FF;
		}
		header img {
		    width: 20px;
		}
		footer{
		    height: 2.5rem;
		    position: fixed;
		    bottom: 0;
		    width: 100%;
		    z-index: 11;
    		background: #fff;
    	}
    	footer img{
		    height: 1rem;
    		margin-bottom: -0.4rem;
    	}
    	.b_l_1{
		    width: 24.8%;
		    height: 2.5rem;
		    /*margin-right: 1%;*/
		    border-right:1px solid #f5f5f5;
		    text-align: center;	
		    float: left;
	        background: #FFFFFF;
	        color: #717372;
    	}
    	.b_l_1 span{
    		font-size: 0.6rem;
    	}
    	.b_l_2{
    		width: 40%;
    		height: 2.5rem;
    		line-height: 2.5rem;
    		float: left;
    		border-right:1px solid #f5f5f5;
    		text-align: center;
    		background: #FFFFFF;
    		color: #717372;
    	}
    	.b_l_2 span{
    		font-size: 0.8rem;
    		color: #323C41;
    	}
    	.unable{
    		width: 90%;
    		height: 1.7rem;
    		background: #1E8DD8;
    		color: #FFF;
    		font-size: 0.8rem;
    		line-height: 1.7rem;
    		text-align: center;
			border-radius: 1.5625rem;
			margin-left: 5%;
			margin-top: 0.4rem;
    	}
    	.buy{
		    background: #1E8DD8;
    	}
    	.buy:active{
    		background:#1E8DD8;
    	}
		.coach_title{
			position: relative;
			width: 100%;
			height: 4.5rem;
			padding: 0 3%;
			margin-top: 0.625rem;
		}
		.coach_title_name{
			position: absolute;
			width: 70%;
			height: 2.5rem;
		}
		.name_level{
			width: 100%;
			height: 1.5rem;
		}
		.name{
			display: inline-block;
			height: 1.5rem;
			line-height: 1.5rem;
			font-size: 1rem;
			white-space:nowrap;
		}
		.level{
			display: inline-block;
			width: 2.5rem;
			vertical-align: middle;
		}
		.star{
			position: relative;
			width: 100%;
			height: 1rem;
		}
		.star_img{
			position: absolute;
			width: 0.5rem;
			height: 0.5rem;
			top: 0.2rem;
		}
		.star_num{
			position: absolute;
			height: 1rem;
			line-height: 1rem;
			font-size: 0.5rem;
			color: #F5A33C;
			left: 0.8rem;
		}
		.coach_img{
			position: absolute;
			width: 27%;
			left: 70%;
			height: 2.5rem;
		}
		.coach_img img{
			position: absolute;
			width: 2.5rem;
			height: 2.5rem;
			left: 50%;
			object-fit:cover;
			margin-left: -1.25rem;
			border-radius:50%;
		}
		.coach_label{
			position: absolute;
			width: 94%;
			height: 1.5rem;
			top: 2.8rem;
			font-size: 0.6rem;
			color: #676974;
		}
		.intention{
			width: 94%;
			height: auto;
			margin-left: 3%;
			border-radius: 0.375rem;
			box-shadow: 0px 0px 8px #D2D0FF;
			padding: 0.625rem 0;
			background: #fff;
		}
		.intention_list:after{
			width: 90% !important;
			height: 1px;
			background-color:#F5F5F5 !important;
			display: block;
			content: '';
			position: absolute;
			top: auto;
			right: auto;
			bottom: 0;
			left: 5% !important;
			z-index: 2;
			-webkit-transform-origin: 50% 100%;
			        transform-origin: 50% 100%;
			pointer-events: none;
		}
		.lebelList{
			display: inline-block;
			width: 25%;
			height: 1.3rem;
			line-height: 1.3rem;
			padding: 0 0.3rem;
			border-radius: 25px;
			background: #F7F8FF;
			font-size: 0.7rem;
			margin-left: 0.7rem;
			margin-bottom: 0.5rem;
			text-align: center;
		}
		.lebelIconS2{
			background: linear-gradient(to right,#64ADF6,#3F86FE);
			color: #fff;
		}
		.license_type{
			position: relative;
		}
		.license_type_icon{
			position: absolute;
			width: 1rem;
			height: 1rem;
			top: 0.6rem;
			right: 0.3rem;
		}
    </style>
	</head>
	<body>
		<div id="menuPackage">
			<header class="aui-bar aui-bar-nav aui-border-b tab1 blue-b none-bottom-style" id="aui-header">
				<a class="aui-pull-left aui-btn" tapmode onclick="closeWin();">
					<img src="../../../icon/common/icon_header_return.png">
				</a>
				<div class="aui-title" id="common_title">
					学车意向
				</div>
				<a class="aui-pull-right aui-btn location">
				</a>
			</header>
		</div>
		<div class="coach_title" id="coach_title">
			<script type="text/template" id="coach_title_s">
				<div class="coach_title_name">
					<div class="name_level">
						<span class="name">{{=it.name}}&nbsp;
						{{ if(it.occupationLevel == 1) { }}
							<img class="level" src="../../../icon/coach/level_one.png">
						{{ }else if(it.occupationLevel == 2) { }}
							<img class="level" src="../../../icon/coach/level_two.png">
						{{ }else if(it.occupationLevel == 3) { }}
							<img class="level" src="../../../icon/coach/level_three.png">
						{{ }else if(it.occupationLevel == 4) { }}
							<img class="level" src="../../../icon/coach/level_four.png">
						{{ } }}
						</span>
					</div>
					<div class="star">
						<img class="star_img" src="../../../icon/coach/coach_star.png">
						<div class="star_num">{{=it.score.toFixed(1)}}分</div>
					</div>
				</div>
				<div class="coach_img">
					<img src="../../../icon/mine/icon_mine_head_hui.png" alt="" onerror="javascript:this.src='../../../icon/mine/icon_mine_head_hui.png'" data-echo="{{=file_load_url +it.photo}}" />
				</div>
				<div class="coach_label">
					所属驾校：{{=it.schoolName}}
				</div>
			</script>
		</div>
		<div class="intention">
			<ul class="aui-list aui-form-list none-top-style none-bottom-style" style="border-radius:3rem;">
				<li class="aui-list-item intention_list" style="">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-label">
							姓名
						</div>
						<div class="aui-list-item-input">
							<input type="text" placeholder="请填写您的姓名" value="" id="name">
						</div>
					</div>
				</li>
				<li class="aui-list-item intention_list" style="">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-label">
							性别
						</div>
						<div class="aui-list-item-input" id="sex_option">
							<!-- <label><input class="aui-radio" type="radio" value='1' name="sex" id="man">&ensp;男</label>
						    &emsp;
						    <label><input class="aui-radio" type="radio" value='2' name="sex" id="woman">&ensp;女</label> -->
						</div>
					</div>
				</li>
				<li class="aui-list-item intention_list" style="">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-label">
							手机号码
						</div>
						<div class="aui-list-item-input">
							<input type="text" placeholder="请填写您的联系电话" value="" id="account">
						</div>
					</div>
				</li>
				<li class="aui-list-item aui-list-item-arrow intention_list">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-label">
							意向车型
						</div>
						<div class="aui-list-item-input license_type" id="license_type" onclick="toLicenceType()">
							<input type="text" placeholder="请选择您的意向车型" value="" id="license_type_input" readonly>
						</div>
					</div>
				</li>
				<li class="aui-list-item none-bottom-style">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-label">
							心中教练
						</div>
						<div class="aui-list-item-input" id="lebel_list">
						</div>
					</div>
				</li>

				<li class="aui-list-item none-bottom-style">
					<ul id="lebel-list">

					</ul>
				</li>
			</ul>
		</div>
		<footer id="foot">
			<div class="unable" id="signUp" tapmode onclick="submit_information()"><span>提交意向</span></div>
		</footer>
		<!-- 性别 -->
		<script type="text/template" charset="utf-8" id='sex_src'>
			{{ for(var i=0;i<it.length;i++){ }}
				{{ if(it.selected == it[i].code){ }}
				 		<label><input class="aui-radio" type="radio" value='{{=it[i].code}}' name="sex" checked>&ensp;{{=it[i].name}}</label>&emsp;
				{{ }else{ }}
				 		<label><input class="aui-radio" type="radio" value='{{=it[i].code}}' name="sex">&ensp;{{=it[i].name}}</label>&emsp;
				{{ } }}
			{{ } }}
		</script>
		<!--标签列表-->
		<script type="text/template" id="lebelLists">
			{{ for(var i=0;i<it.length;i++){ }}
			<li class="lebelList" data-type="0" tapmode onclick="selectLebel('{{=it[i].id}}','{{=it[i].code}}',this)">{{=it[i].name}}</li>
		{{ } }}
		</script>
	</body>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../script/jquery_3_2_1_min.js"></script>
	<script type="text/javascript" src="../../../script/doT_min.js"></script>
	<script src="../../../script/echo.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../../script/common/common.js"></script>
	<script type="text/javascript">
		var cache;
		var headerPos;
		var footPos;
		var clearance = 25; //间隙
		var coachLabel; //教练标签
		var carType; //准教车型
		var headerPos;
		var threshold; //定义的阈值
		var touchStyle;
		var systemType; //系统类型
		var bMap;
		var fs;
		var flag = 0;
		var articleId; //驾校详情ID
		var licenseTypeMap;
		var coachLebelCodeList = []; //选择的教练标签
		var carTypeCode; //已选择的车型code
		var carTypeCodeName; //已选择的车型name
		var coach_cache;
		var coach_id;
		var select_car_code; //选择的车型code
		var select_car_name; //选择的车型name
		apiready = function() {
			api.parseTapmode();
			$api.fixStatusBar($api.byId('menuPackage'));
			var header = $api.byId('menuPackage');
			var foot = $api.byId('foot');
			headerPos = $api.offset(header);
			footPos = $api.offset(foot);
			cache = api.pageParam;
			log('cache:', cache)
			coach_cache = cache.coach_cache;
			coach_id = coach_cache.id;
			select_car_code = cache.car_code;
			select_car_name = cache.car_name;
			if(select_car_code != '' && select_car_name != ''){
				$('#license_type_input').val(select_car_name)
				carTypeCode = select_car_code;
				carTypeCodeName = select_car_name;
			}
			fs = api.require('fs');
			bMap = api.require('bMap');
			systemType = api.systemType;
			defaultload();
			var coach_title_s = $('#coach_title_s').html();
			$('#coach_title').html(doT.template(coach_title_s)(coach_cache));
			setTimeout(function() {
				echoInit();
			}, 300)
			init();
			load_user_info();
			lebelList();
			closedefaultload();

			toEventListener('carType', function(ret, err) {
				log('选择车型:', ret.value.carType)
				$('#license_type_input').val(ret.value.carType[0].name)
				carTypeCode = ret.value.carType[0].code;
				carTypeCodeName = ret.value.carType[0].name;
			})
		}

		function init() {
			var cache_dictionary = $api.getStorage('cache_by_app').cache_dictionary;
			var cache_account = $api.getStorage('cache_by_account').cache_account;
			//性别
			var sex_src = $('#sex_src').html();
			$('#sex_option').html(doT.template(sex_src)(cache_dictionary['006000'].dictionaryList));

			if (isauth()) { //已提交认证，则加载全部实名认证信息（包含认证中和认证通过）
				cache_dictionary['006000'].dictionaryList.selected = cache_account.sex;
				$('#sex_option').html(doT.template(sex_src)(cache_dictionary['006000'].dictionaryList)); //性别
			}
		}

		//加载数据到驾校报名
		function load_user_info() {
			licenseTypeMap = $api.getStorage('cache_by_app').licenseTypeMap;
			log('渠道：', licenseTypeMap)
			//缓存中的字典表数据
			var cache_dictionary = $api.getStorage('cache_by_app').cache_dictionary;
			updateLearnerInfo(function(ret, err) {
				if (ret && ret.code == 0) {
					// console.log('学员信息:'+JSON.stringify(ret));

					$('#name').val(ret.learner.name); //真实姓名

					$('#account').val(ret.learner.account); //手机号码，也是账户名

					//检验标准
					// checkStandard();

				} else {
					alert_msg('获取学员信息失败');
				}
			});
		}

		/**
		 * 标签列表
		 */
		function lebelList() {
			var url = 'api/coach/coach-tags';
			var params = {};
			ajax_Request(url, 'get', 'json', params, function(ret, err) {
				log('ret:', ret)
				if (ret) {
					if (ret.code == 0) {
						var lebelLists = $("#lebelLists").html();
						$('#lebel-list').html(doT.template(lebelLists)(ret.returnValue))
						api.parseTapmode();
					} else {
						alert_msg(ret.msg)
					}
				} else {
					alert_msg('系統异常')
				}
			})
		}
		/**
		 * 点击选择标签
		 * data-type 0 未选中 1选中
		 */
		function selectLebel(id, code, e) {
			var type = $(e).attr('data-type');
			log('', type)
			log('', coachLebelCodeList)
			if (type == '0') {
				coachLebelCodeList.push(code)
				if (coachLebelCodeList.length > 3) {
					alert_msg('标签最多选择3个')
					for (var i = 0; i < coachLebelCodeList.length; i++) {
						if (coachLebelCodeList[i] == code) {
							coachLebelCodeList.splice(i, 1)
						}
					}
				} else {
					$(e).addClass('lebelIconS2')
					$(e).attr('data-type', '1')
				}
			} else if (type == '1') {
				$(e).removeClass('lebelIconS2')
				$(e).attr('data-type', '0')
				for (var i = 0; i < coachLebelCodeList.length; i++) {
					if (coachLebelCodeList[i] == code) {
						coachLebelCodeList.splice(i, 1)
					}
				}
			}
		}

		function toLicenceType() {
			api.openWin({
				name: 'license_type',
				url: './license_type.html',
				slidBackEnabled: 'false',
				vScrollBarEnabled: 'false',
				hScrollBarEnabled: 'false',
				reload: true,
				useWKWebView: false,
				pageParam: {
					teachPermitted: coach_cache.teachPermitted,
					carTypeCode: carTypeCode,
					carTypeCodeName: carTypeCodeName
				}
			});
		}

		//设置页面加载的画面
		function setLoad() {
			if (refresh || $('#student_evaluate').find('li').length == 0) { //如果是刷新或者之前无数据的下拉刷新，全屏提示
				$('#load_div').html('');
			} else {
				setTimeout(function() {
					$('#load_div').html(doT.template(more_src)({
						'msg': '加载更多中...',
						'img': '../../../icon/common/jiazai.gif'
					}));
				}, 500);
			}
		}


		//设置出错页面;
		function setError(msg) {
			var error_src = $('#error_src').html();
			$('#driverschoolDetail').html(doT.template(error_src)({}));
			alert_msg(msg);
		}


		/**
		 * 提交报名教练
		 */
		function submit_information() {
			var name = $('#name').val();
			if (name == null || name == '') {
				alert_msg('请输入姓名');
				return;
			}
			var account = $('#account').val();
			if (account == null || account == '') {
				alert_msg('请输入手机号');
				return;
			}

			if (carTypeCode == null || carTypeCode == '') {
				alert_msg('请选择意向车型');
				return;
			}
			
			var sex = $('input:radio[name="sex"]:checked').val(); //性别
			if (sex == '' || sex == null) {
				alert_msg('请选择性别');
				return;
			}
			
			if(coachLebelCodeList == '' || coachLebelCodeList == null){
				alert_msg('请选择心中教练');
				return;
			}
			
			params = {
				coachId: coach_id,
				learnerId: getUserId(),
				carType: carTypeCode,
				name:name,
				phone:account,
				tags:coachLebelCodeList.join(','),
				sex:sex,
				source:1
			}
			log('提交参数',params)
			var url = 'api/coach/insert-learner-incorrect';
			ajax_Request(url, 'post', 'json', params, function(ret, err) {
				log('ret:', ret)
				if (ret) {
					if (ret.code == 0) {
						alert_msg('提交成功!')
						setTimeout(function() {
							api.closeWin();
						}, 1000)
					} else {
						alert_msg(ret.msg)
					}
				} else {
					alert_msg('系統异常')
				}
			})

		}


		function closeWin() {
			api.closeWin({});
		}
	</script>
</html>
