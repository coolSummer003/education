<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>驾校报名</title>
		<link rel="stylesheet" type="text/css" href="../../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/aui/aui_2_0.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/common/common.css" />
		<style>
			html,
		body {
			height: 100%;
			
		}
		#over {
		
			width: 100%;
			height:100%;
			background-image: url(../../../icon/coach/bg.png);
			position:absolute;
			top:0rem;
			
			background-repeat: no-repeat;
			background-size:100% 50%;
			z-index: 3;
		}
    	.aui-bar-nav,.aui-bar-tab{
    	    background-color: #ffffff;
    	}
    	.aui-bar-nav{
    		color:#2c2c2c;
    		font-weight: 700;
    	}
	   	a.aui-pull-left, a.aui-pull-right {
		    color: #35A7FF;
		}
		header img {
		    width: 20px;
		}
		#driver_s_title{
		    font-weight: normal;
		}
		#code{
			width:70%;
		}
		.sendCode{
	        width: 50%;
		    height: 1.8rem;
		    text-align: center;
		    line-height: 1.8rem;
		    border: solid 1px #F1F1F1;
		    border-radius: 1rem;
		}
		.block-bottom-style:after{
			width: 74%;
		    height: 1px;
		    background-color: #dddddd;
		    display: block;
		    content: '';
		    position: absolute;
		    top: auto;
		    right: 0;
		    bottom: 0;
		    z-index: 2;
		    -webkit-transform-origin: 50% 100%;
		    transform-origin: 50% 100%;
		    pointer-events: none;
		}
		.aui-list .aui-list-item-label, .aui-list .aui-list-item-label-icon {
		    color: #212121;
		    width: 35%;
		    min-width: 1.5rem;
		    margin: 0;
		    padding: 0;
		    padding-right: 0.25rem;
		    line-height: 2.2rem;
		    
		    position: relative;
		    overflow: hidden;
		    white-space: nowrap;
		    max-width: 100%;
		    -webkit-box-sizing: border-box;
		    box-sizing: border-box;
		    display: inline;
		    -webkit-align-items: center;
		    align-items: center;
		    text-align: right;
		}
		
		.msg{
			font-size:0.7rem;
		}
		.delete{
		    width: 1.2rem !important;
		    height: 1.2rem !important;
		    position: absolute;
            right: -0.6rem;
    		top: -0.6rem;
		    z-index:10;
		}
		.check-style{
		    font-size: 0.7rem;
		    color: #03B4F7;
		    text-align: right;
		    position: absolute;
		    top: 3.2rem;
		    right: -5rem;
		}
		#other_area{
			color:#03B4F7;
		}
		.arrow_blue:before{
			border: 1px solid #03B4F7;
			border-top: none;
    		border-right: none;
		}
		#entryFee{
			color:#FB6500;
		}
		#look-pic{
			color:#03B4F7;
		}
		.icon_img{
			width:1rem;
		    margin-bottom: -0.2rem;
		}
		.aui-label-info {
		    color: #ffffff;
		    background-color: #FFB476;
		    margin-right: 0.5rem;
		}
		
		#learnPlan{
			padding:0.5rem 0rem;
			background:#FAFAFA;
		}
		.plan-empty{
		    padding: 0.5rem 0rem;
    		background: #FAFAFA;
    		color: #989898;
		    text-align: center;
    		font-size: 0.6rem;
		}
		.plan-empty img{
			width:1rem;
		}
		.aui-content{
			 position: absolute;
			 bottom: 0rem;
			 width: 100%;
			padding-top: 1rem;
			padding-bottom:1rem;
			background:#ffffff;
			border-radius:1rem 1rem 0 0 ;
		}
		.aui-list-item-label{
		width:2rem;
		}
		.aui-btn-infos{
			color: #ffffff !important;
		    background-image: linear-gradient(270deg, #3F86FE 0%, #64ADF6 99%);
		    margin-top: 2rem !important;
			border-radius: 1rem;
		
		}
		.lebelList{
			display: inline-block;
			width: auto;
			padding: 0.1rem 0.3rem;
			border-radius: 25px;
			background: #ddd;
			font-size: 0.7rem;
			margin-left: 0.5rem;
			margin-bottom: 0.5rem;
		}
		.lebelIconS2{
			background: #03B4F7;
			color: #fff;
		}
    </style>
	</head>
	<body>
		<header class="aui-bar aui-bar-nav none-bottom-style aui-hide" id="aui-header1" style="background: none;">
			<a class="aui-pull-left aui-btn" tapmode onclick="closeWin();">
				<img src="../../../icon/common/icon_header_return_white.png">
			</a>
			<div class="aui-title">

			</div>

		</header>
		<header class="aui-bar aui-bar-nav none-bottom-style" id="aui-header2" style="background: none;">
			<a class="aui-pull-left aui-btn" tapmode onclick="closeWin();">
				<img src="../../../icon/common/icon_header_return_white.png">
			</a>
			<div class="aui-title" id="driver_s_title" style="color:#FFFFFF;">
				报名咨询
			</div>

		</header>
		<div id="over">
			<div class="aui-content ">
				<ul class="aui-list aui-form-list none-top-style none-bottom-style" style="border-radius:3rem;">
					<li class="aui-list-item" style="">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								姓&emsp;&emsp;名：
							</div>
							<div class="aui-list-item-input">
								<input type="text" placeholder="请输入姓名" value="" id="name" readonly>
							</div>
						</div>
					</li>
					<li class="aui-list-item" style="">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								性&emsp;&emsp;别：
							</div>
							<div class="aui-list-item-input" id="sex_option">
								<!-- <label><input class="aui-radio" type="radio" value='1' name="sex" id="man">&ensp;男</label>
							    &emsp;
							    <label><input class="aui-radio" type="radio" value='2' name="sex" id="woman">&ensp;女</label> -->
							</div>
						</div>
					</li>
					<li class="aui-list-item" style="">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								手机号码：
							</div>
							<div class="aui-list-item-input">
								<input type="text" placeholder="请输入手机号码" value="" id="account" readonly>
							</div>
						</div>
					</li>

					<li class="aui-list-item none-bottom-style">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								邮寄地址：
							</div>
							<div class="aui-list-item-input bottom-slide aui-list-item-arrow" tapmode onclick='select_address()'>
								<input type="text" placeholder="请选择邮寄地址" id="addressView" readonly>
							</div>
						</div>
					</li>
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">

							</div>
							<div class="aui-list-item-input">
								<input type="text" placeholder="详细地址" id="addressDetail">
							</div>
						</div>
					</li>

					<li class="aui-list-item aui-list-item-arrow">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								报考车型：
							</div>
							<div class="aui-list-item-input" id="license_type">
							</div>
						</div>
					</li>

					<li class="aui-list-item aui-list-item-arrow none-bottom-style">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								申请业务：
							</div>
							<div class="aui-list-item-input" id="business_level1_cd">
							</div>
						</div>
					</li>

					<li class="aui-list-item none-bottom-style">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">
								心中教练：
							</div>
							<div class="aui-list-item-input" id="lebel_list">
							</div>
						</div>
					</li>

					<li class="aui-list-item none-bottom-style">
						<ul id="lebel-list">

						</ul>
					</li>

					<div class="aui-btn aui-btn-infos aui-btn-block" id="" style="background: background-image: linear-gradient(270deg, #3F86FE 0%, #64ADF6 99%) !important;"
					 tapmode onclick="sign_up()">提交学车意向</div>
				</ul>
			</div>
		</div>
		<!-- 准驾类型src -->
		<script type="text/template" charset="utf-8" id='license_type_src'>
			<select type="select" id="licenseType" onchange="checkStandard()">
	 		{{ for(var i=0;i<it.length;i++){ }}
	 			{{ if(i==0){ }}
		        	<option value="{{=it[i]}}" selected="">{{=teach_permitted_code(it[i])}}</option>
	 			{{ }else{ }}
		        	<option value="{{=it[i]}}" >{{=teach_permitted_code(it[i])}}</option>
	 			{{ } }}
	 		{{ } }}
        </select>
	 </script>

		<!-- 申请业务src -->
		<script type="text/template" charset="utf-8" id='business_level1_cd_src'>
			<select type="select" id="businessLevel1Cd" onchange="checkStandard()">
	 		{{ for(var i=0;i<it.length;i++){ }}
	 			{{ if(it[i].code == '028001'){ }}
		        	<option value="{{=it[i].code}}" selected>{{=it[i].name}}</option>
	 			{{ }else{ }}
		        	<option value="{{=it[i].code}}">{{=it[i].name}}</option>
	 			{{ } }}
	 		{{ } }}
        </select>
	 </script>
		<!-- 性别 -->
		<script type="text/template" charset="utf-8" id='sex_src'>
			{{ for(var i=0;i<it.length;i++){ }}
	 		{{ if(it.selected == it[i].code){ }}
		 		<label><input class="aui-radio" type="radio" value='{{=it[i].code}}' name="sex" checked>&ensp;{{=it[i].name}}</label>&emsp;
	 		{{ }else{ }}
		 		<label><input class="aui-radio" type="radio" value='{{=it[i].code}}' name="sex">&ensp;{{=it[i].name}}</label>&emsp;
	 		{{ } }}
	 	{{ } }}
	 </script>
		<!--标签列表-->
		<script type="text/template" id="lebelLists">
			{{ for(var i=0;i<it.length;i++){ }}
			<li class="lebelList" data-type="0" onclick="selectLebel('{{=it[i].id}}','{{=it[i].code}}',this)">{{=it[i].name}}</li>
		{{ } }}
	</script>
	</body>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../script/jquery_3_2_1_min.js"></script>
	<script type="text/javascript" src="../../../script/doT_min.js"></script>
	<script type="text/javascript" src="../../../script/common/common.js"></script>
	<script type="text/javascript">
		var cache;
		var isload = false; //是否已经加载成功的标识
		var addressViewCode = '';
		var imageFilter;
		var licenseTypeMap;
		var postalCode; //邮编
		var selected_address_id; //选中地址的id
		var coach_id; //教练名称
		var coach_name; //教练姓名
		var school_id;
		var touchStyle;
		var businessLevel1Cd;
		var coachLebelCodeList = []; //选择的教练标签
		apiready = function() {
			cache = api.pageParam;
			log('cache', cache);
			$api.fixStatusBar($api.byId('aui-header1'));
			$api.fixStatusBar($api.byId('aui-header2'));
			systemType = api.systemType;
			touchStyle = systemType == "ios" ? 'touchmove' : 'scroll';
			headerPos = $api.offset($api.byId('aui-header1'));
			threshold = headerPos.h;
			coach_id = cache.id;
			scroll()

			//监听地址选择
			toEventListener('driver_pre_sign_up', function(ret) {
				//log('地址',ret.value);
				var address_info = ret.value;
				$('#addressView').val(address_info.district.provinceName + address_info.district.cityName + address_info.district
					.districtName);
				$('#addressDetail').val(address_info.addressDetail);
				addressViewCode = address_info.districtCd;
				postalCode = address_info.postalCode;
				selected_address_id = address_info.id;
			});

			api.parseTapmode();
			init();
			lebelList();
		}
		var tagNameList = [];

		function init() {
			//字典表缓存
			var cache_dictionary = $api.getStorage('cache_by_app').cache_dictionary;
			var cache_account = $api.getStorage('cache_by_account').cache_account;
			tagNameList = cache.teachPermitted.split(',');
			log('tagNameList:',tagNameList)
			var license_type_src = $('#license_type_src').html();
			$('#license_type').html(doT.template(license_type_src)(tagNameList));

			//性别
			var sex_src = $('#sex_src').html();
			$('#sex_option').html(doT.template(sex_src)(cache_dictionary['006000'].dictionaryList));

			//申请业务
			var business_level1_cd_src = $('#business_level1_cd_src').html();
			$('#business_level1_cd').html(doT.template(business_level1_cd_src)(cache_dictionary['028000'].dictionaryList));

			//$('#other_area').html('户口不在' + cache.district.cityName + cache.district.districtName + '请点击');
			if(isauth()){//已提交认证，则加载全部实名认证信息（包含认证中和认证通过）
				cache_dictionary['006000'].dictionaryList.selected = cache_account.sex;
				$('#sex_option').html(doT.template(sex_src)(cache_dictionary['006000'].dictionaryList));//性别
			}
			
			//加载用户信息
			load_user_info();
			isload = true;


		}

		

		function teach_permitted_code(code) {

			licenseTypeMap = $api.getStorage('cache_by_app').licenseTypeMap;
			log('licenseTypeMap', licenseTypeMap);
			return licenseTypeMap[code] != undefined ? licenseTypeMap[code].name : '';
		}

		//监听页面滑动控制头部menu样式
		var scrollPos; //监听上下滚动顶部的距离
		var percent = 0; //白底header的隐藏属性值
		var hidepercent = 0; //非白底header的隐藏属性值
		function scroll() {
			$(window).on(touchStyle, function(event) {
				scrollPos = $(window).scrollTop();
				//安卓做限制滚动
				if (((scrollPos / threshold).toFixed(2) <= 1) && systemType == 'android') {
					percent = (scrollPos / threshold).toFixed(2);
					$('#aui-header2').css("opacity", percent);
					hidepercent = 1 - percent;
					$('#aui-header1').css("opacity", hidepercent);
				} else {
					percent = (scrollPos / threshold).toFixed(2) > 1 ? 1 : (scrollPos / threshold).toFixed(2);
					$('#aui-header2').css("opacity", percent);
					hidepercent = (1 - percent) < 0 ? 0 : (1 - percent);
					$('#aui-header1').css("opacity", hidepercent);
				}
			});
		}



		/**
		 * 选择省市区 
		 */
		function select_address() {
			params = {
				selected_address_id: selected_address_id, //选中的地址id，可能为空，用来标记
				isSelect: true, //是否是选择
				action: 'driver_pre_sign_up' //动作监听name
			}
			api.openWin({
				name: 'common_address_list_win',
				url: '../../common/learner_address/common_address_list_win.html',
				slidBackEnabled: 'false',
				vScrollBarEnabled: 'false',
				hScrollBarEnabled: 'false',
				reload: true,
				useWKWebView: false,
				pageParam: params
			});
		}

		//加载数据到驾校报名
		function load_user_info() {
			licenseTypeMap = $api.getStorage('cache_by_app').licenseTypeMap;
			log('渠道：',licenseTypeMap)
			//缓存中的字典表数据
			var cache_dictionary = $api.getStorage('cache_by_app').cache_dictionary;
			updateLearnerInfo(function(ret, err) {
				if (ret && ret.code == 0) {
					// console.log('学员信息:'+JSON.stringify(ret));

					$('#name').val(ret.learner.name); //真实姓名

					$('#account').val(ret.learner.account); //手机号码，也是账户名
					
					//检验标准
					checkStandard();

				} else {
					alert_msg('获取学员信息失败');
				}
			});
		}

		//检验标准
		var min_age = 0;
		var max_age = 100;

		function checkStandard() {
			var code = $('#licenseType').val();

			if (code != '') {
				min_age = licenseTypeMap[code].min_age;
				max_age = licenseTypeMap[code].max_age;
				//获取驾考类型的对应套餐
			} else {
				$('#entryFee').html('未选择报考车型');
			}

			var cache_account = $api.getStorage('cache_by_account').cache_account;


			businessLevel1Cd = $('#businessLevel1Cd').val(); //申请业务种类

		}

		//点击报名
		function sign_up() {
			if (isload) { //页面加载成功
				var code = $('#licenseType').val();
				var name = $('#name').val();
				if (name == null || name == '') {
					alert_msg('请输入姓名');
					return;
				}
				var account = $('#account').val();
				if (account == null || account == '') {
					alert_msg('请输入手机号');
					return;
				}
				var addressView = $('#addressView').val(); //省市区
				if (addressView == null || addressView == '') {
					alert_msg('请选择邮寄地址');
					return;
				}
				var addressDetail = $('#addressDetail').val(); //详细地址
				if (addressDetail == null || addressDetail == '') {
					alert_msg('请填写详细地址');
					return;
				}
				var licenseType = $('#licenseType').val(); //报考车型
				if (licenseType == null || licenseType == '') {
					alert_msg('请选择报考车型');
					return;
				}

				var sex = $('input:radio[name="sex"]:checked').val(); //性别
				if (sex == '' || sex == null) {
					alert_msg('请选择性别');
					return;
				}

				//套餐名称
				var learnPlanName = $('input[name="learnPlan"]:checked').parent().parent().find('.plan-name').html();

				if (businessLevel1Cd == null || businessLevel1Cd == '') {
					alert_msg('请选择申请业务种类');
					return;
				}
				params = {
					coachId: coach_id,
					learnerId: getUserId(),
					district: addressViewCode,
					mailingAddress: addressDetail,
					carType: licenseType,
					busiType: $('#businessLevel1Cd').find('option:selected').val(),
					name:name,
					phone:account,
					tags:coachLebelCodeList.join(','),
					sex:sex,
					source:1
				}
				// setTimeout(function() {
				// 	openFrameAlert('../driver_school_pre_sign_up_sure_frm', params, 0, api.winHeight);
				// }, 300);
				var url = 'api/coach/insert-learner-incorrect';
				ajax_Request(url, 'post', 'json', params, function(ret, err) {
					log('ret:', ret)
					if (ret) {
						if (ret.code == 0) {
							alert_msg('提交成功!')
							setTimeout(function() {
								api.closeWin();
							}, 1000)
						} else {
							alert_msg(ret.msg)
						}
					} else {
						alert_msg('系統异常')
					}
				})
			} else {
				alert_msg('页面未加载成功，请返回重试');
			}
		}

		function closeWin() {
			api.closeWin({});
		}

		/**
		 * 标签列表
		 */
		function lebelList() {
			var url = 'api/coach/coach-tags';
			var params = {};
			ajax_Request(url, 'get', 'json', params, function(ret, err) {
				log('ret:', ret)
				if (ret) {
					if (ret.code == 0) {
						var lebelLists = $("#lebelLists").html();
						$('#lebel-list').html(doT.template(lebelLists)(ret.returnValue))
					} else {
						alert_msg(ret.msg)
					}
				} else {
					alert_msg('系統异常')
				}
			})
		}

		/**
		 * 点击选择标签
		 * data-type 0 未选中 1选中
		 */
		function selectLebel(id, code, e) {
			var type = $(e).attr('data-type');
			log('', type)
			log('', coachLebelCodeList)
			if (type == '0') {
				coachLebelCodeList.push(code)
				if (coachLebelCodeList.length > 3) {
					alert_msg('标签最多选择3个')
					for (var i = 0; i < coachLebelCodeList.length; i++) {
						if (coachLebelCodeList[i] == code) {
							coachLebelCodeList.splice(i, 1)
						}
					}
				} else {
					$(e).addClass('lebelIconS2')
					$(e).attr('data-type', '1')
				}
			} else if (type == '1') {
				$(e).removeClass('lebelIconS2')
				$(e).attr('data-type', '0')
				for (var i = 0; i < coachLebelCodeList.length; i++) {
					if (coachLebelCodeList[i] == code) {
						coachLebelCodeList.splice(i, 1)
					}
				}
			}
		}
	</script>
</html>
