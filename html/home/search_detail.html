<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>选择所属城市</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../css/aui/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/common.css" />
		<style>
			html,body{
			background: #FFF;
		}
		#menuPackage{
			background:#FFF;
			position:fixed;
			top:0;
			left:0;
			width:100%;
			z-index:999;
		}
		#menu{
			font-size:1rem;
		}
		.location-info{
			margin-top:2.5rem;
		}
		.select{
	    	height: 2.5rem;
		    line-height: 2.5rem;
		    /* text-align: right; */
		    position: relative;
	    }
	    .select_kuang{
	    	width: 3rem;
		    position: absolute;
		    right: 0.5rem;
		    text-align: right;
		    font-size: 1rem;
	    }
	    .aui-searchbar-cancel img{
    		width:1.1rem;
    		margin-top: 0.25rem;
    	}
    	.messageNum{
		    width: 0.9rem;
		    height: 0.9rem;
		    background: #DC251F;
		    border-radius: 100%;
		    color: #FFF;
		    position: absolute;
		    right: 0.2rem;
		    top: 0.3rem;
		    line-height: 0.9rem;
		    font-size: 0.8rem;
		    text-align: center;
    	}
    	.aui-searchbar-input {
		    margin: 0 0.5rem;
		    background-color: #F3F4F4;
		    border-radius: 1rem;
		    height: 1.8rem;
		    line-height: 1.8rem;
		    font-size: 1rem;
		    width: 100%;
		    position: relative;
		    padding-left: 0.5rem;
		    display: -webkit-box;
		    -webkit-box-flex: 1;
		    border: solid 1px #F1F1F1;
		}
		.aui-searchbar .aui-searchbar-cancel {
		    font-size: 0.9rem;
		    color: #666666;
		    margin-right: 0.3rem;
		    width: 2.3rem;
		    height: 1.5rem;
		    line-height: 1.5rem;
		    text-align: left;
		    -webkit-transition: all .3s;
		    transition: all .3s;
		    color: #FFF;
		    padding-left:0.2rem;
		}
		.aui-searchbar-input input::-webkit-input-placeholder {
			color: #9FA7AB;
			font-size:0.9rem;
		}
		.aui-searchbar-cancel span{
			color:#03B4F7;
			font-size:1rem;	
		}
		.img_delete{
            width: 0.9rem;
		    height: 0.9rem;
		    position: absolute;
		    top: 0.4rem;
		    right: 0.4rem;
		    display:none;
    	}
    	label{
		    font-size: 0.8rem;
    		margin: 0.5rem;
    		color:#666666;
    	}
    	.cuurent-content{
    		padding-bottom:0.5rem;
    	}
    	.cuurent-location{
		    display: flex;
		}
    	.location{
		    margin: auto;
	        display: -webkit-inline-box;
	        width: 100%;
	        padding-left: 0.5rem;
    	}
    	.location span{
    		margin-left: 0.2rem;
    		font-weight: bold;
    	}
    	.location img{
    		width:0.7rem;
    		height:0.7rem;
    		margin-top: 0.2rem;
    	}
    	.reload-location{
    		margin: auto;
    		width: 100%;
    		text-align:right;
    		padding-right:0.5rem;
    		font-size:0.9rem;
    		color:#03B4F7;
    	}
    	.line{
    		background:#F3F4F4;
    		height:0.5rem;
    	}
    	.cuurent-content ul{
    		overflow:hidden;
    	}
    	.cuurent-content li{
		    background: #F3F4F4;
		    width: 30%;
		    float: left;
		    margin-left: 2.5%;
		    height: 1.7rem;
		    line-height: 1.7rem;
		    text-align: center;
		    border-radius: 0.2rem;
		    margin-bottom: 0.5rem;
	        color: #666666;
	        font-size:0.9rem;
    	}
    	.aui-searchbar-input input {
		    color: #666666;
		    width: 92%;
		    padding: 0 1.6rem 0 0.4rem;
		    margin: 0.2rem 0rem;
		    height: 1.4rem;
		    min-height: 1.4rem;
		    line-height: 1.4rem;
		    border: 0;
		    -webkit-appearance: none;
		    font-size: 1rem;
		    position: relative;
		}
		.active{
			background: #eaf3ff !important;
			color: #03B4F7 !important;
		}
		#area_list{
			margin-top:2.5rem;
		}
    </style>
	</head>
	<body>
		<div id="menuPackage" class=''>
			<div class="aui-searchbar select" id="search">
				<!-- <div class="aui-searchbar-input aui-border-radius">
		        <i class="aui-iconfont aui-icon-search"></i>
		    	            <input type="search" placeholder="输入城市名" id="search-input">
		    	            <img src="../../icon/common/icon_delete.png" alt="" class="img_delete"/>
		    </div>
		    <div class="aui-searchbar-cancel" tapmode onclick='hiddenCitySel()'>
		    	<span>取消</span>
		    </div> -->
			</div>
		</div>

		<!-- 定位信息 -->
		<div class='location-info'>
			<div class='cuurent-content'>
				<label>当前定位</label>
				<div class='cuurent-location'>
					<div class='location' tapmode onclick='selCity(this)'>
						<img src="../../icon/hospital/icon_location_new.png" alt="" />
						<span id='address-city'>定位中...</span>
						<input type="hidden" id='address-city-code' value='' />
					</div>
					<div class='reload-location' tapmode onclick='reloadLocation()'>重新定位</div>
				</div>
			</div>
			<div class='line'></div>
			<div class='cuurent-content' id='city_list'>

			</div>
			<script type="text/template" charset="utf-8" id="city_list_src">
				<label>城市列表</label>
			<ul>
				{{ for(var i=0;i< it.sub.length;i++){ }}
					{{ for(var j=0;j< it.sub[i].sub.length;j++){ }}
						{{ if(it.sub[i].sub[j].id == '330600000'){ }}
							<li tapmode onclick = 'selectCity(this,"{{=it.sub[i].sub[j].id}}")'><span>{{=it.sub[i].sub[j].name}}</span></li>
						{{ } }}
					{{ } }}
				{{ } }}
			</ul>
		</script>
			<!-- 地区选择列表信息 -->
			<div class='district-list' id='sel_area_list'>
			</div>
			<script type="text/template" charset="utf-8" id="sel_area_list_src">
				<label for="">地区列表</label>
			<div class="aui-content aui-margin-b-15">
				<ul class="aui-list aui-list-in">
					{{ for(var i=0;i< it.sub.length;i++){ }}
						{{ for(var j=0;j< it.sub[i].sub.length;j++){ }}
							{{ for(var k=0;k< it.sub[i].sub[j].sub.length;k++){ }}
								{{ if(it.sub[i].sub[j].id == it.city_code){ }}
							        <li class="aui-list-item sel_area" tapmode onclick='selCity(this)'>
							            <div class="aui-list-item-inner">
							                <div class="aui-list-item-title">
							                	<span>{{=it.sub[i].sub[j].sub[k].name}}</span>
							                	<input type="hidden" id="{{=it.sub[i].sub[j].sub[k].id}}" value='{{=it.sub[i].sub[j].sub[k].id}}'/>
							                </div>
							                <div class="aui-list-item-right">{{=it.sub[i].sub[j].name}}</div>
							            </div>
							        </li>
								{{ } }}
					        {{ } }}
				        {{ } }}
				    {{ } }}
				</ul>
			</div>
		</script>
		</div>

		<!-- 地区搜索列表信息 -->
		<div class="aui-content aui-margin-b-15" id='area_list'>
		</div>
		<script type="text/template" charset="utf-8" id="area_list_src">
			<ul class="aui-list aui-list-in">
		{{ for(var i=0;i< it.sub.length;i++){ }}
			{{ for(var j=0;j< it.sub[i].sub.length;j++){ }}
				{{ for(var k=0;k< it.sub[i].sub[j].sub.length;k++){ }}
					{{ if(it.sub[i].sub[j].sub[k].name.indexOf(it.keyword) != -1 || it.sub[i].sub[j].name.indexOf(it.keyword) != -1){ }}
				        <li class="aui-list-item" tapmode onclick='selCity(this)'>
				            <div class="aui-list-item-inner">
				                <div class="aui-list-item-title">
				                	<span>{{=it.sub[i].sub[j].sub[k].name}}</span>
				                	<input type="hidden" value='{{=it.sub[i].sub[j].sub[k].id}}'/>
				                </div>
				                <div class="aui-list-item-right">{{=it.sub[i].sub[j].name}}</div>
				            </div>
				        </li>
					{{ } }}
		        {{ } }}
	        {{ } }}
	    {{ } }}
	    </ul>
	</script>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/jquery_3_2_1_min.js"></script>
	<script type="text/javascript" src="../../script/doT_min.js"></script>
	<script type="text/javascript" src="../../script/common/common.js"></script>
	<script type="text/javascript">
		var systemType;
		var bMap;
		var cache;
		var screenName; //列表进行筛选关键字
		var cityCode, cityName;
		apiready = function() {
			var search = $api.byId('aui-header');
			systemType = api.systemType;
			cache = api.pageParam.data;
			bMap = api.require('bMap');
			$api.fixStatusBar(search);
			toEventListener('screenName', function(ret, err) {
				log('筛选名称', ret)
				screenName = ret.value.screenName;
			})
			toEventListener('screenCode', function(ret, err) {
				log('筛选名称', ret.value)
				log('筛选名称', ret.value.cityCode != '' && ret.value.cityCode != null && ret.value.cityCode != undefined)
				if (ret.value.cityCode != '' && ret.value.cityCode != null && ret.value.cityCode != undefined) {
					log('进来了', 'wocaasdf')
					cityCode = ret.value.cityCode;
					cityName = ret.value.cityName;
					log('', $('#' + cityCode).parent().parent().parent())
					$('#' + cityCode).parent().parent().parent().addClass('active').siblings().removeClass('active');
					$('#' + cityCode).siblings().addClass('active').parent().parent().parent().siblings().find('span').removeClass(
						'active');
				} else {
					log('进来了', 'woca')
					$('#sel_area_list').find('ul').find('li').removeClass('active').find('span').removeClass('active');
				}
			})
			//获取城市列表
			getCityList();

			var cache_by_app = $api.getStorage('cache_by_app');
			if (cache_by_app.location_city != undefined) {
				$('#address-city').html(cache_by_app.location_city.cityName);
			}

			//获取当前定位
			setTimeout(function() {
				getLocation();
			}, 300);
		};

		/**
		 * 获取城市列表 
		 */
		var cityList; //城市列表
		function getCityList() {
			url = 'api/dictionary/all/district';
			ajax_Request(url, 'get', 'json', null, function(ret, err) {
				log('省市区', ret);
				if (ret && ret.code == 0) {
					cityList = ret;
					//加载城市列表
					city_load();
					//输入初始化
					input_init();
				} else {
					alert_msg('获取城市列表失败');
				}
			});
		}
		
		/**
		 * 加载城市列表
		 */
		function city_load() {
			var city_list_src = $('#city_list_src').html();
			$('#city_list').html(doT.template(city_list_src)(cityList));
			api.parseTapmode();
		}

		/**
		 * 选择城市列表 
		 */
		var sel_area_list_src = $('#sel_area_list_src').html();
		function selectCity(e, city_code) {
			console.log(city_code);
			$('#city_list').find('li').removeClass('active');
			$(e).addClass('active');
			cityList.city_code = city_code;
			$('#sel_area_list').html(doT.template(sel_area_list_src)(cityList));
			api.parseTapmode();
		}

		/**
		 * 获取当前定位 
		 */
		function getLocation() {
			getCurrentAddress();
		}

		/**
		 * 选择城市 
		 */
		function selCity(e) {
			if ($(e).hasClass("active")) {
				$(e).find('span').removeClass("active");
				$(e).removeClass("active");
				params = {
					cityName: '',
					cityCode: ''
				}
			} else {
				$('.sel_area').removeClass("active");
				$('.sel_area').find('span').removeClass("active");
				$(e).find('span').addClass("active");
				$(e).addClass("active");
				params = {
					cityName: $(e).find('span').html(),
					cityCode: $(e).find('input').val()
				}
			}
			//		if(params.cityCode == ''){return;}
			//		
			//当前定位信息放入缓存
			/*var cache_by_app = $api.getStorage('cache_by_app');
			cache_by_app.location_city = params;
			$api.setStorage('cache_by_app', cache_by_app);*/
			sendEvent(screenName, params);
			api.parseTapmode();
			setTimeout(function() {
				hiddenCitySel();
			}, 300);
			if (cache.action === 'school_filter') {
				esc_function('index', 'search_shadow', 'closeSearchShadow()');
			}
		}

		/**
		 *  获取当前地址
		 */
		function getCurrentAddress() {
			mylocation(function(ret) {
				if (location_result.status) {
					//有定位权限
					bMap.getNameFromCoords({
						lon: ret.lon,
						lat: ret.lat
					}, function(ret, err) {
						if (ret && ret.status) {
							$('#address-city').html(ret.district);
							$('#address-city-code').val(ret.adCode + '000'); //与后台数据对应需要加上000
							params = {
								cityName: $('.sel_area').find('span').html(),
								cityCode: ret.adCode + '000'		
							}
							//当前定位信息放入缓存
							/*var cache_by_app = $api.getStorage('cache_by_app');
							cache_by_app.location_city = params;
							$api.setStorage('cache_by_app', cache_by_app);*/
							sendEvent(screenName, params);
							api.parseTapmode();
							//
							if (systemType == 'ios') {}
						} else {
							$('#address-city').html('定位失败');
							$('#address-city-code').val('');
						}
					});
				} else {
					//无定位权限
					$('#address-city').html('无定位');
					$('#address-city-code').val('');
				}
			});
		}

		/**
		 * 重新获取定位 
		 */
		function reloadLocation() {
			$('#address-city').html('定位中...');
			setTimeout(function() {
				getLocation();
			}, 300);
		}

		function input_init() {
			//监听输入框输入
			$('#search-input').bind('input propertychange', function() {
				if ($(this).val() != '') {
					cityList.keyword = $(this).val();
					$('.location-info').addClass('aui-hide');
					$(".img_delete").css("display", "block");
					var area_list_src = $('#area_list_src').html();
					$('#area_list').html(doT.template(area_list_src)(cityList));
					api.parseTapmode();
				} else {
					$('.location-info').removeClass('aui-hide');
					$(".img_delete").css("display", "none");
					$('#area_list').html('');
				}
			});
			$(".img_delete").click(function() {
				$("#search-input").val("");
				$('.location-info').removeClass('aui-hide');
				$(".img_delete").css("display", "none");
				$('#area_list').html('');
				keyWord = "";
			});
		}


		/**
		 * 隐藏城市选择 
		 */
		function hiddenCitySel() {
			api.closeDrawerPane();
		}
	</script>
</html>
