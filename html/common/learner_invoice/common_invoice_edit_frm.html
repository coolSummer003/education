<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>编辑发票</title>
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/aui/aui_2_0.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/common/common.css"/>
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }

        header img {
            width: 20px;
        }


        .newAdd {
            width: 90%;
            margin: 1rem 5%;
            height: 2rem;
            border-radius: 25px;
            overflow: hidden;
            background: linear-gradient(to left, #3F86FE, #64ADF6);
            color: #fff;
            font-size: 0.9rem;
            text-align: center;
            line-height: 2rem;
        }

        .aui-grid [class*=aui-col-] {
            display: table-cell;
            position: relative;
            text-align: center;
            vertical-align: middle;
            padding: 0.5rem 0;
        }


        .aui-grid [class*=aui-col-xs-]:active {
            background-color: #FFFFFF;
        }

        .aui-card-list-header {
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
        }

        footer {
            height: 2.5rem;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 0.8rem;
            left: 0;
            background: #ffffff;
        }

        .footer-input div {
            min-height: 1.7rem;
            background: linear-gradient(to right, #78D6FA, #05B4F7);
            padding: 0 0.5rem;
            margin-top: 0.4rem;
            border-radius: 1rem;
            line-height: 1.7rem;
        }

        .main {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }


        .wrapper1 {
            height: 1.5rem;
            float: left;
        }
        .wrapper {
            display: inline;
            height: 1.5rem;
            float: left;
            margin-right: 1rem;
        }

        .box {
            display: inline;
            float: left;
            width: 100%;
            height: 100%;
            position: relative;
            vertical-align: middle;
            border-radius: 100%;
            text-align: center;
        }

        .box input {
            display: none;
        }

        .box label {
            display: block;
            width: 3.5rem;
            height: 1.5rem!important;
            background: #fff;
            z-index: 1;
            border-radius: 0.725rem;
            border: 1px solid #FFFFFF;
            line-height: 1.5rem!important;
            text-align: center;
        }


        input[type="radio"] + label {
            background: #F7F8FF;
            color: #999;
            border: none;
            padding: 0 0.5rem;
            width: 4.5rem;
            font-size: 0.7rem;
        }

        input[type="radio"]:checked + label {
            background: #3F86FF;
            border: none;
            color: #fff;
            padding: 0 0.5rem;
            width: 4.5rem;
            font-size: 0.7rem;
        }

        .aui-list-item-label {
            height: 2rem;
            font-size: 0.8rem;
            color: #666 !important;
            line-height: 2rem;
        }

        span {
            font-size: 0.55rem;
            color: #767676;
            width: 85%;
            margin-top: 0.25rem;
        }

        .inputs::-webkit-input-placeholder {
            color: red;
        }

        #unit {
            display: none;
        }

        #unit1 {
            display: block;
        }

        .invoice-type {
            min-height: 1rem !important;
            line-height: 1rem !important;
            font-size: 0.8rem;
            color: #333;
            padding: 0 0.75rem !important;
            margin: 0.5rem 0;
            border-left: 3px solid #3F86FF;
        }

        .personal-invoice-title {
            min-height: 1rem !important;
            line-height: 1rem !important;
            font-size: 0.8rem !important;
            padding: 0 !important;
            margin: 0;
        }

        .receiver-title {
            min-height: 1rem !important;
            line-height: 1rem !important;
            font-size: 0.8rem;
            color: #333;
            padding: 0 0.75rem !important;
            margin: 0.5rem 0;
            border-left: 3px solid #3F86FF;
        }

        input::placeholder {
            color: #999 !important;
        }


        .aui-list-item-middle {
            height: 0.5rem;
            background-color: #f5f5f5;
        }

        .bottom-line:after {
            width: 100%;
            height: 1px;
            background-color: #dddddd;
            display: block;
            content: '';
            position: absolute;
            top: auto;
            right: auto;
            bottom: 0;
            left: 0;
            z-index: 2;
            -webkit-transform-origin: 50% 100%;
            transform-origin: 50% 100%;
            pointer-events: none;
        }

        .aui-list-item-label {
            min-height: 2.5rem;
            height: 2.5rem;
            line-height: 2.5rem;
            overflow: hidden;
        }

        .aui-list.aui-select-list .aui-list-item-inner {
            padding-bottom: 0;
        }

        #ul:before {
            height: 0;
        }

        .aui-list-item-label span {
            display: block;
            float: left;
            width: 27.5%;
            height: 1.5rem;
            line-height: 1.5rem;
            margin-top: 0;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .aui-list-item-label input {
            display: block;
            float: left;
            min-height: 1.5rem;
            height: 100%;
            line-height: 1.5rem;
            vertical-align: middle;
            width: 72.5%;
            font-size: 0.8rem;
            color: #333;
            background-color: #fff;
        }

        ul:after, li:after {
            height: 0!important;
        }
    </style>
</head>
<body>

<div class="main">
    <ul class="aui-list aui-select-list" id="ul">
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-card-list-header invoice-type">
                    发票类型
                </div>
                <div class="aui-list-item-inner">
                    <div id="radio1">
                        <div class="wrapper">
                            <div class="box">
                                <input type="radio" id="is_personal" name="invoiceType" checked="checked"/>
                                <label for="is_personal">个人发票</label>
                            </div>
                        </div>
                        <div class="wrapper1">
                            <div class="box">
                                <input type="radio" id="is_personal1" name="invoiceType"/>
                                <label for="is_personal1">单位发票</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="unit">
                    <div class="aui-list-item-label bottom-line">
                        <span>单位名称<i style="color:#FF685B;">*</i></span>
                        <input type="text" id="entity_name" class="entity_name input" placeholder="请填写单位名称">
                    </div>
                    <div class="aui-list-item-label bottom-line">
                        <span>发票税号<i style="color:#FF685B;">*</i></span>
                        <input type="text" id="input" class="inputs input" placeholder="请在此填写纳税人识别号">

                    </div>
                    <div class="aui-list-item-label" tapmode onclick="showSelectInvoiceType()">
                        <span>发票种类<i style="color:#FF685B;">*</i></span>
                        <input type="text" id="invoice_type" placeholder="请选择发票种类" disabled>
                    </div>
                </div>
                <div id="unit1" class="personal-invoice-title">
                    <div class="aui-list-item-label">
                        <span>发票抬头<i style="color:#FF685B;">*</i></span>
                        <input type="text" id="name" class="name input" placeholder="请填写开票人姓名">
                    </div>
                </div>
            </div>
        </li>
        <li class="aui-list-item-middle"></li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner" style="padding: 0 0.75rem 0 0;">
                <div class="aui-card-list-header receiver-title">
                    收票人信息
                </div>
                <div class="aui-list-item-label bottom-line">
                    <span>手机号码<i style="color:#FF685B;">*</i></span>
                    <input type="tel" id="phone" class="phone input" placeholder="请输入手机号码" maxlength="11">
                </div>
                <div class="aui-list-item-label">
                    <span>收件邮箱<i style="color:#FF685B;">*</i></span>
                    <input type="email" id="email" class="email input" placeholder="请输入收件邮箱">
                </div>
            </div>
        </li>
    </ul>
</div>
<!-- 新增 -->
<div class="newAdd aui-hide" id='add' tapmode onclick="submitAddress()">提交</div>
<!-- 修改 -->
<div id='edit' class='aui-hide'>
    <div class="newAdd edit-left" tapmode onclick="submitAddress()">
        提交
    </div>
    <!--    <div class="newAdd edit-right" tapmode onclick="deleteAddress()">
            删除
        </div>-->
</div>

</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/jquery_3_2_1_min.js"></script>
<script type="text/javascript" src="../../../script/doT_min.js"></script>
<script type="text/javascript" src="../../../script/common/common.js"></script>
<script type="text/javascript">
    var learnerId;
    var is_personal; //发票抬头
    var name; //收票人姓名
    var phone; //电话
    var mail; //邮箱
    var entity_name; //单位名称
    var ein; //税号
    var invoice_type = ''; // 发票类型
    var cache;
    var systemType;
    apiready = function () {
        cache = api.pageParam;
        log("cache:", cache);
        learnerId = getUserId();
        systemType = api.systemType;
        init();
        if (cache.flag == "modify") {
            //修改
            $("#edit").removeClass('aui-hide');
        } else if (cache.flag == "new") {
            //新增
            $("#add").removeClass('aui-hide');
        }
        toEventListener('set_invoice_type', function (ret, err) {
            invoice_type = ret.value.type;
            if (parseInt(ret.value.type) === 1) {
                $('#invoice_type').val('专用发票');
            } else {
                $('#invoice_type').val('普通发票');
            }
        });
    };

    //发票抬头切换时改变div
    $("input[name=invoiceType]").click(function () {
        var name = $(this).attr("id");
        if (name == 'is_personal') {
            $('#unit').attr("style", "display:none;");
            $('#unit1').attr("style", "display:block;");
            is_personal = '0';
        } else {
            $('#unit1').attr("style", "display:none;");
            $('#unit').attr("style", "display:block;");
            is_personal = '1';
        }
    });

    // 切换显示个人发票和单位发票
    function showTab(index) {
        if (index === 0) {
            $('.wrapper').attr("style", "display:block;");
            $('#is_personal').attr("checked", "checked");
            $('.wrapper1').attr("style", "display:none;");
            $('#is_personal1').removeAttr("checked");
            $('#unit').attr("style", "display:none;");
            $('#unit1').attr("style", "display:block;");
            is_personal = '0';
        } else {
            $('.wrapper1').attr("style", "display:block;");
            $('#is_personal1').attr("checked", "checked");
            $('.wrapper').attr("style", "display:none;");
            $('#is_personal').removeAttr("checked");
            $('#unit1').attr("style", "display:none;");
            $('#unit').attr("style", "display:block;");
            is_personal = '1';
        }
    }

    /**
     * 加载地址详情
     */
    function init() {
        if (cache.flag == "new") {
            if (cache.isEmpty) {
                showTab(0);
                $('.wrapper1').attr("style", "display:block;");
                $('.wrapper').attr("style", "display:block;");
            } else {
                cache.isPersonal == 1 ? showTab(1) : showTab(0);
            }
        } else {
            if (cache.isPersonal == 1) {
                showTab(1);
                $('.entity_name').val(cache.entity_name);
                $('.inputs').val(cache.ein);
                invoice_type = cache.type;
                if (cache.type !== undefined) {
                    $('#invoice_type').val(cache.type == 1 ? '专用发票' : '普通发票');
                }
            } else if (cache.isPersonal == 0) {
                showTab(0);
                $('.name').val(cache.name);
            }
            $('.phone').val(cache.phone);
            $('.email').val(cache.mail);
        }


        //软键盘弹出时隐藏确定按钮，调整页面
        if (systemType == 'ios') {
            $('.input').bind('focus', function () {
                $('#footer').css('position', 'static');

            }).bind('blur', function () {
                $('#footer').css({
                    'position': 'fixed',
                    'bottom': '0'
                });

            });

        } else {
            var winHeight = $(window).height(); //获取当前页面高度
            $(window).resize(function () {
                var thisHeight = $(this).height();
                if (winHeight - thisHeight > 100) {
                    $('#footer').css('position', 'static'); //键盘弹出

                    if ($(".email").is(":focus")) {
                        document.getElementById('email').scrollIntoView({
                            block: "start",
                            behavior: "smooth"
                        });
                    }
                    if ($(".phone").is(":focus")) {
                        document.getElementById('phone').scrollIntoView({
                            block: "start",
                            behavior: "smooth"
                        });
                    }
                    if ($(".entity_name").is(":focus")) {
                        document.getElementById('entity_name').scrollIntoView({
                            block: "start",
                            behavior: "smooth"
                        });
                    }

                    if ($(".name").is(":focus")) {
                        document.getElementById('name').scrollIntoView({
                            block: "start",
                            behavior: "smooth"
                        });
                    }
                    if ($(".inputs").is(":focus")) {
                        document.getElementById('input').scrollIntoView({
                            block: "start",
                            behavior: "smooth"
                        });
                    }
                } else {
                    $('#footer').css({
                        'position': 'fixed',
                        'bottom': '0'
                    }); //键盘收起

                }
            })

        }
    }

    // 验证手机号码和邮箱
    function checkPhoneAndMail(phone, mail) {
        if (!phone) {
            alert_msg('手机号码不能为空！');
            return false;
        }
        if (!isPhoneAvailable(phone)) {
            alert_msg('手机号码格式错误！');
            return false;
        }
        if (!mail) {
            alert_msg('收件邮箱不能为空！');
            return false;
        }
        if (!isEmailAvailable(mail)) {
            alert_msg('收件邮箱格式错误！');
            return false;
        }
        return true;
    }


    function isEmailAvailable(emailInput) {
        var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
        return myreg.test(emailInput);
    }


    //提交信息
    function submitAddress() {
        // 获取输入框值并验证
        name = $('.name').val().trim();
        phone = $('.phone').val().trim();
        mail = $('.email').val().trim();
        ein = $('.inputs').val().trim();
        entity_name = $('.entity_name').val();
        if (parseInt(is_personal) === 0) {
            invoice_type = 0;
            // 个人发票
            if (!name) {
                alert_msg('发票抬头不能为空！');
                return;
            }
            if (name < 2 || name.length > 10) {
                alert_msg('请填入真实姓名！');
                return;
            }
            if (!checkPhoneAndMail(phone, mail)) {
                return;
            }
        } else {
            // 单位发票
            if (!entity_name) {
                alert_msg('单位名称不能为空！');
                return;
            }
            if (entity_name.length > 30) {
                alert_msg('请填入真实单位名称！');
                return;
            }
            if (!ein) {
                alert_msg('纳税人识别号不能为空！');
                return;
            }
            if (ein.length > 30) {
                alert_msg('请填入真实纳税人识别号！');
                return;
            }
            if (!invoice_type) {
                alert_msg('请选择发票种类！');
                return;
            }
            if (!checkPhoneAndMail(phone, mail)) {
                return;
            }
        }
        // 提交数据
        if (cache.flag === "new") {
            url = "/api/invoices/add/InvoiceSettingInfo";
            params = {
                learnerId: getUserId(),
                is_personal: is_personal,
                name: name,
                phone: phone,
                mail: mail,
                ein: ein,
                entity_name: entity_name,
                type: invoice_type
            };
            ajax(url, params, 'post');
        } else if (cache.flag === "modify") {
            url = "/api/invoices/update/InvoiceSettingInfo";
            params = {
                learnerId: getUserId(),
                is_personal: is_personal,
                name: name,
                phone: phone,
                mail: mail,
                ein: ein,
                entity_name: entity_name,
                type: invoice_type
            };
            ajax(url, params, 'put');
        }
    }

    function ajax(url, params, requestMethod) {
        log("params：", params);
        log("url：", url);
        defaultload('正在提交中');
        ajax_Request(url, requestMethod, "json", params, function (ret, err) {
            log("添加数据：", ret);
            if (ret) {
                closedefaultload();
                if (ret.code == 0) {
                    alert_msg(requestMethod === 'post' ? "新增成功" : '修改成功');
                    sendEvent('init');
                    setTimeout(function() {
                        api.closeWin({});
                    }, 500);
                } else {
                    setTimeout(function() {
                        openMessage_i('提示',
                            requestMethod === 'post' ? "新增失败，请稍后重试" : '修改失败，请稍后重试', '确定', '', '', '', null)
                    }, 100);
                }
            } else {
                alert_msg("服务器繁忙，请稍后再试");
            }
        })
    }

    //删除地址
    function deleteAddress() {
        openMessage_i('提示', '是否删除该发票', '确定', '取消', 'deleteArs()', '', null)
    }

    function deleteArs() {
        if (!is_personal) {
            is_personal = 0;
        }
        url = "/api/invoices/del/InvoiceSettingInfo";
        params = {
            learnerId: getUserId(),
            is_personal: is_personal
        }
        log("params：", params);
        ajax_Request(url, "post", "json", params, function (ret, err) {
            if (ret) {
                log("ret：", ret);
                if (ret.code == 0) {
                    alert_msg("删除成功");
                    setTimeout(function () {
                        api.closeWin({});
                        api.sendEvent({
                            name: 'init'
                        });
                    }, 500);
                } else {
                    alert_msg("删除失败")
                }
            } else {
                alert_msg("服务器繁忙，请稍后再试")
            }
        })
    }

    //打开通用弹出框
    //title标题 content内容 sureButton确认按钮文字 sureFunc确定方法 cancelFunc取消方法 cancelButton取消按钮文字 params额外参数，没有必须传null
    function openMessage_i(title, content, sureButton, cancelButton, sureFunc, cancelFunc, params) {
        api.openFrame({
            name: 'common_alert',
            url: '../../common/common_alert.html',
            bgColor: 'rgba(0,0,0,0.4)',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: api.winHeight
            },
            bounces: false,
            pageParam: {
                title: title,
                content: content,
                sureButton: sureButton,
                sureFunc: sureFunc,
                cancelButton: cancelButton,
                cancelFunc: cancelFunc,
                winName: api.winName,
                frameName: api.frameName,
                params: params
            },
            softInputBarEnabled: true,
            softInputMode: 'resize'
        });
    }

    // 显示发票种类模态框
    function showSelectInvoiceType() {
        setTimeout(function () {
            api.openFrame({
                name: 'common_invoice_type_shadow',
                url: './common_invoice_type_shadow.html',
                bgColor: 'rgba(0,0,0,0.3)',
                rect: {
                    x: 0,
                    y: 0,
                    w: 'auto',
                    h: api.winHeight
                },
                bounces: false,
                softInputBarEnabled: true,
                softInputMode: 'resize',
                pageParam: {type : invoice_type}
            });
        }, 200);
    }

</script>
</html>
